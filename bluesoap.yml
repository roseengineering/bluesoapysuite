---
  - set_fact:
      fs_path: "{{ fs_path | default('/srv') }}"

  # apt

  - become: yes
    apt:
      name:
      - python3-dbus
      - mosquitto

  # pip

  - become: yes
    pip:
      name:
      - bluezero
      - paho-mqtt

  # ble

  - become: yes
    copy:
      dest: /etc/dbus-1/system.d/ukBaz.bluezero.conf 
      content: |
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE busconfig PUBLIC 
         "-//freedesktop//DTD D-BUS Bus Configuration 1.0//EN"
         "http://www.freedesktop.org/standards/dbus/1.0/busconfig.dtd">
        <busconfig>
          <policy context="default">
            <allow own="ukBaz.bluezero"/>
            <allow send_destination="ukBaz.bluezero"
                   send_interface="org.freedesktop.DBus.Introspectable"/>
            <allow send_type="method_call" log="true"/>
          </policy>
        </busconfig>

  # bluesoapy

  - become: yes
    copy:
      mode: 0755
      dest: /usr/local/bin/mqproxy
      content: !!binary |
        IyEvdXNyL2Jpbi9weXRob24zCmZyb20gYmx1ZXplcm8gaW1wb3J0IHBlcmlw
        aGVyYWwKClVBUlRfU0VSSVZDRSA9ICc2RTQwMDAwMS1CNUEzLUYzOTMtRTBB
        OS1FNTBFMjREQ0NBOUUnClJYX0NIQVJBQ1RFUklTVElDID0gJzZFNDAwMDAy
        LUI1QTMtRjM5My1FMEE5LUU1MEUyNERDQ0E5RScKVFhfQ0hBUkFDVEVSSVNU
        SUMgPSAnNkU0MDAwMDMtQjVBMy1GMzkzLUUwQTktRTUwRTI0RENDQTlFJwoK
        Y2xhc3MgVWFydFNlcnZpY2U6CiAgICBkZWYgX19pbml0X18oc2VsZiwgb25y
        ZWFkLCBhbGlhcz0nUlBpX1VBUlQnKToKICAgICAgICBzZWxmLm9ucmVhZCA9
        IG9ucmVhZAogICAgICAgIHNlbGYuYXBwID0gcGVyaXBoZXJhbC5BcHBsaWNh
        dGlvbigpCiAgICAgICAgc2VsZi5ibGVfdWFydCA9IHBlcmlwaGVyYWwuU2Vy
        dmljZShVQVJUX1NFUklWQ0UsIFRydWUpCiAgICAgICAgc2VsZi5yeF91YXJ0
        ID0gcGVyaXBoZXJhbC5DaGFyYWN0ZXJpc3RpYyhSWF9DSEFSQUNURVJJU1RJ
        QywKICAgICAgICAgICAgWyd3cml0ZScsICd3cml0ZS13aXRob3V0LXJlc3Bv
        bnNlJ10sIHNlbGYuYmxlX3VhcnQpCiAgICAgICAgc2VsZi50eF91YXJ0ID0g
        cGVyaXBoZXJhbC5DaGFyYWN0ZXJpc3RpYyhUWF9DSEFSQUNURVJJU1RJQywK
        ICAgICAgICAgICAgWydub3RpZnknXSwgc2VsZi5ibGVfdWFydCkKICAgICAg
        ICBzZWxmLnJ4X3VhcnQuYWRkX3dyaXRlX2V2ZW50KHNlbGYudWFydF9wcmlu
        dCkKICAgICAgICBzZWxmLmJsZV91YXJ0LmFkZF9jaGFyYWN0ZXJpc3RpYyhz
        ZWxmLnJ4X3VhcnQpCiAgICAgICAgc2VsZi5ibGVfdWFydC5hZGRfY2hhcmFj
        dGVyaXN0aWMoc2VsZi50eF91YXJ0KQogICAgICAgIHNlbGYuYXBwLmFkZF9z
        ZXJ2aWNlKHNlbGYuYmxlX3VhcnQpCiAgICAgICAgc2VsZi5hcHAuZG9uZ2xl
        LmFsaWFzID0gYWxpYXMKICAgIGRlZiB1YXJ0X3ByaW50KHNlbGYsIGRhdGEp
        OgogICAgICAgIHZhbHVlID0gJycuam9pbihjaHIobGV0dGVyKSBmb3IgbGV0
        dGVyIGluIGRhdGEpCiAgICAgICAgc2VsZi5vbnJlYWQodmFsdWUpCiAgICBk
        ZWYgc3RhcnQoc2VsZik6CiAgICAgICAgc2VsZi5hcHAuc3RhcnQoKQoKIyMj
        IyMjIyMjIyMjIyMjIyMjIyMjIwoKaW1wb3J0IGFyZ3BhcnNlCmltcG9ydCBw
        YWhvLm1xdHQuY2xpZW50IGFzIG1xdHQKZnJvbSBkYXRldGltZSBpbXBvcnQg
        ZGF0ZXRpbWUKCnBhcnNlciA9IGFyZ3BhcnNlLkFyZ3VtZW50UGFyc2VyKAog
        ICAgZm9ybWF0dGVyX2NsYXNzPWFyZ3BhcnNlLkFyZ3VtZW50RGVmYXVsdHNI
        ZWxwRm9ybWF0dGVyKQpwYXJzZXIuYWRkX2FyZ3VtZW50KCItLWJyb2tlciIs
        IGRlZmF1bHQ9IjEyNy4wLjAuMSIsIGhlbHA9J2Jyb2tlciBob3N0JykKcGFy
        c2VyLmFkZF9hcmd1bWVudCgiLS1wb3J0IiwgZGVmYXVsdD0xODgzLCBoZWxw
        PSdicm9rZXIgcG9ydCcpCnBhcnNlci5hZGRfYXJndW1lbnQoIi0ta2VlcGFs
        aXZlIiwgZGVmYXVsdD02MCwgaGVscD0nYnJva2VyIGtlZXAgYWxpdmUnKQpw
        YXJzZXIuYWRkX2FyZ3VtZW50KCItLXRvcGljIiwgZGVmYXVsdD0iZi90eCIs
        IGhlbHA9J2NvbW1hbmQgdG9waWMnKQoKZGVmIG1haW4oKToKICAgIGRlZiBv
        bmNvbm5lY3QoY2xpZW50LCB1c2VyZGF0YSwgZmxhZ3MsIHJjKToKICAgICAg
        ICBjbGllbnQuc3Vic2NyaWJlKCcjJykKICAgIGRlZiBvbndyaXRlKHZhbHVl
        KToKICAgICAgICBjbGllbnQucHVibGlzaChhcmdzLnRvcGljLCB2YWx1ZSkK
        ICAgIGRlZiBvbm1lc3NhZ2UoY2xpZW50LCB1c2VyZGF0YSwgbXNnKToKICAg
        ICAgICBwYXlsb2FkID0gbXNnLnBheWxvYWQuZGVjb2RlKCdsYXRpbicpCiAg
        ICAgICAgdHMgPSBkYXRldGltZS5ub3coKS5zdHJmdGltZSgnJUg6JU06JVMn
        KQogICAgICAgIHVhcnQudHhfdWFydC5zZW5kX25vdGlmeV9ldmVudChmJ3t0
        c30ge21zZy50b3BpY30ge3BheWxvYWR9JykKICAgIHVhcnQgPSBVYXJ0U2Vy
        dmljZShvbndyaXRlKQogICAgY2xpZW50ID0gbXF0dC5DbGllbnQoKQogICAg
        Y2xpZW50Lm9uX2Nvbm5lY3QgPSBvbmNvbm5lY3QKICAgIGNsaWVudC5vbl9t
        ZXNzYWdlID0gb25tZXNzYWdlCiAgICBjbGllbnQuY29ubmVjdChhcmdzLmJy
        b2tlciwgYXJncy5wb3J0LCBhcmdzLmtlZXBhbGl2ZSkKICAgIGNsaWVudC5s
        b29wX3N0YXJ0KCkKICAgIHVhcnQuc3RhcnQoKQoKaWYgX19uYW1lX18gPT0g
        J19fbWFpbl9fJzoKICAgICMgcHJveHkgYmxlIHVhcnQgdG8gbXF0dCBicm9r
        ZXIKICAgICMgdGhpcyBuZWVkcyB0byBydW4gYXMgcm9vdAogICAgYXJncyA9
        IHBhcnNlci5wYXJzZV9hcmdzKCkKICAgIG1haW4oKQoK


  - become: yes
    copy:
      mode: 0755
      dest: /usr/local/bin/mqsoapy
      content: !!binary |
        IyEvdXNyL2Jpbi9weXRob24zCgppbXBvcnQgb3MsIHN5cywgdGltZQppbXBv
        cnQgc3RydWN0CmltcG9ydCBhcmdwYXJzZQppbXBvcnQgbnVtcHkgYXMgbnAK
        aW1wb3J0IHBhaG8ubXF0dC5jbGllbnQgYXMgbXF0dAppbXBvcnQgU29hcHlT
        RFIKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUKZnJvbSBTb2FweVNE
        UiBpbXBvcnQgU09BUFlfU0RSX1JYLCBTT0FQWV9TRFJfQ0YzMgoKcmVzdGFy
        dF9zZWNvbmRzID0gMTAKCnBhcnNlciA9IGFyZ3BhcnNlLkFyZ3VtZW50UGFy
        c2VyKAogICAgZm9ybWF0dGVyX2NsYXNzPWFyZ3BhcnNlLkFyZ3VtZW50RGVm
        YXVsdHNIZWxwRm9ybWF0dGVyKQoKcGFyc2VyLmFkZF9hcmd1bWVudCgiLS1i
        cm9rZXIiLCBkZWZhdWx0PSIxMjcuMC4wLjEiLCBoZWxwPSdicm9rZXIgaG9z
        dCcpCnBhcnNlci5hZGRfYXJndW1lbnQoIi0tcG9ydCIsIGRlZmF1bHQ9MTg4
        MywgdHlwZT1pbnQsIGhlbHA9J2Jyb2tlciBwb3J0JykKcGFyc2VyLmFkZF9h
        cmd1bWVudCgiLS1rZWVwYWxpdmUiLCBkZWZhdWx0PTYwLCB0eXBlPWludCwg
        aGVscD0nYnJva2VyIGtlZXBhbGl2ZSBpbiBzZWNvbmRzJykKcGFyc2VyLmFk
        ZF9hcmd1bWVudCgiLS10b3BpYyIsIGRlZmF1bHQ9ImYvdHgiLCBoZWxwPSdt
        cXR0IHRvcGljIGZvciBjb21tYW5kJykKcGFyc2VyLmFkZF9hcmd1bWVudCgi
        LS1wcHMtdG9waWMiLCBkZWZhdWx0PSJwcHMiLCBoZWxwPSdtcXR0IHRvcGlj
        IGZvciBncHMgcHBzIHRpbWUnKQpwYXJzZXIuYWRkX2FyZ3VtZW50KCItLWRy
        aXZlciIsIGhlbHA9J25hbWUgb2YgZHJpdmVyJykKcGFyc2VyLmFkZF9hcmd1
        bWVudCgiLS1wYWNrZXQtc2l6ZSIsIGRlZmF1bHQ9MTAyNCwgdHlwZT1pbnQs
        IGhlbHA9J3BhY2tldCBzaXplJykKcGFyc2VyLmFkZF9hcmd1bWVudCgiLS1m
        cmVxIiwgdHlwZT1ucC5mbG9hdCwgaGVscD0iY2VudGVyIGZyZXF1ZW5jeSBp
        biBoZXJ0eiIpCnBhcnNlci5hZGRfYXJndW1lbnQoIi0tcmF0ZSIsIHR5cGU9
        bnAuZmxvYXQsIGhlbHA9InNhbXBsZSByYXRlIGluIGhlcnR6IikKcGFyc2Vy
        LmFkZF9hcmd1bWVudCgiLS1nYWluIiwgdHlwZT1ucC5mbG9hdCwgaGVscD0i
        ZnJvbnQgZW5kIGdhaW4gaW4gZEIiKQpwYXJzZXIuYWRkX2FyZ3VtZW50KCIt
        LWFnYyIsIGFjdGlvbj0ic3RvcmVfdHJ1ZSIsIGhlbHA9ImVuYWJsZSBBR0Mi
        KQpwYXJzZXIuYWRkX2FyZ3VtZW50KCItLW5vYnJva2VyIiwgYWN0aW9uPSJz
        dG9yZV90cnVlIiwgaGVscD0iZGlzYWJsZSBtcXR0IGJyb2tlciIpCnBhcnNl
        ci5hZGRfYXJndW1lbnQoIi0tZHVtYiIsIGFjdGlvbj0ic3RvcmVfdHJ1ZSIs
        IGhlbHA9ImR1bWIgdGVybWluYWwiKQpwYXJzZXIuYWRkX2FyZ3VtZW50KCIt
        LW91dHB1dCIsIGRlZmF1bHQ9Im91dCIsIGhlbHA9IndyaXRlIENGMzIgc2Ft
        cGxlcyB0byBmaWxlIikKcGFyc2VyLmFkZF9hcmd1bWVudCgiLS1ub3dhdmUi
        LCBhY3Rpb249InN0b3JlX3RydWUiLCBoZWxwPSJkaXNhYmxlIFdBViBoZWFk
        ZXIiKQpwYXJzZXIuYWRkX2FyZ3VtZW50KCItLW1ldGVyIiwgYWN0aW9uPSJz
        dG9yZV90cnVlIiwgaGVscD0iZW5hYmxlIGNvbnNvbGUgcGVhayBtZXRlciIp
        CnBhcnNlci5hZGRfYXJndW1lbnQoIi0tcGF1c2UiLCBhY3Rpb249InN0b3Jl
        X3RydWUiLCBoZWxwPSJwYXVzZSBvdXRwdXQiKQpwYXJzZXIuYWRkX2FyZ3Vt
        ZW50KCItLXJlZnJlc2giLCBkZWZhdWx0PTUsIHR5cGU9aW50LCBoZWxwPSJw
        ZWFrIG1ldGVyIHJlZnJlc2ggaW4gc2Vjb25kcyIpCnBhcnNlci5hZGRfYXJn
        dW1lbnQoIi0tcmVmcmVzaC1wcHMiLCBkZWZhdWx0PTEwLCB0eXBlPWludCwg
        aGVscD0ncHBzIHJlZnJlc2ggaW4gc2Vjb25kcycpCiAKIyBhcmdTdHJpbmcK
        cGFyc2VyLmFkZF9hcmd1bWVudCgiLS1kaXJlY3Qtc2FtcCIsIGhlbHA9IjA9
        b2ZmLCAxIG9yIGk9SSwgMiBvciBxPVEgY2hhbm5lbCIpCnBhcnNlci5hZGRf
        YXJndW1lbnQoIi0taXEtc3dhcCIsIGFjdGlvbj0ic3RvcmVfdHJ1ZSIsIGhl
        bHA9InN3YXAgSVEgc2lnbmFscyIpCnBhcnNlci5hZGRfYXJndW1lbnQoIi0t
        Ymlhc3RlZSIsIGFjdGlvbj0ic3RvcmVfdHJ1ZSIsIGhlbHA9ImVuYWJsZSBi
        aWFzIHRlZSIpCnBhcnNlci5hZGRfYXJndW1lbnQoIi0tZGlnaXRhbC1hZ2Mi
        LCBhY3Rpb249InN0b3JlX3RydWUiLCBoZWxwPSJlbmFibGUgZGlnaXRhbCBB
        R0MiKQpwYXJzZXIuYWRkX2FyZ3VtZW50KCItLW9mZnNldC10dW5lIiwgYWN0
        aW9uPSJzdG9yZV90cnVlIiwgaGVscD0iZW5hYmxlIG9mZnNldCB0dW5lIikK
        CgpkZWYgZ2VuX3RvcGljKG5hbWU9Tm9uZSk6CiAgICBkID0gYXJncy50b3Bp
        Yy5zcGxpdCgnLycpWzotMV0KICAgIGlmIG5hbWUgaXMgbm90IE5vbmU6CiAg
        ICAgICAgZC5hcHBlbmQobmFtZSkKICAgIHJldHVybiAnLycuam9pbihkKQoK
        CmRlZiB0b19mbG9hdChwYXJhbSk6CiAgICB0cnk6CiAgICAgICAgcmV0dXJu
        IGZsb2F0KHBhcmFtKQogICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAg
        cGFzcwoKIyMjCgpkZWYgb25fZmF0YWwocGFyYW0pOgogICAgZ2xvYmFsIGZh
        dGFsCiAgICBpZiBwYXJhbS5sb3dlcigpID09ICJ0cnVlIjoKICAgICAgICBm
        YXRhbCA9IFRydWUKICAgICAgICBpbmZvKCdmYXRhbCBraWxsaW5nJykKICAg
        IGVsc2U6CiAgICAgICAgaW5mbygnYmFkIGZhdGFsIGNvbW1hbmQnKQoKCmRl
        ZiBvbl9raWxsKHBhcmFtKToKICAgIGdsb2JhbCBraWxsZWQKICAgIGlmIHBh
        cmFtLmxvd2VyKCkgPT0gInRydWUiOgogICAgICAgIGtpbGxlZCA9IFRydWUK
        ICAgICAgICBpbmZvKCdraWxsaW5nIHN0cmVhbScpCiAgICBlbHNlOgogICAg
        ICAgIGluZm8oJ2JhZCBraWxsIGNvbW1hbmQnKQoKCmRlZiBvbl9wYXVzZShw
        YXJhbSk6CiAgICBnbG9iYWwgcGF1c2VkCiAgICBpZiBwYXJhbToKICAgICAg
        ICBwYXVzZWQgPSBwYXJhbS5sb3dlcigpID09ICJ0cnVlIgogICAgYnJva2Vy
        LnB1Ymxpc2goZ2VuX3RvcGljKCJwYXVzZSIpLCAnb24nIGlmIHBhdXNlZCBl
        bHNlICdvZmYnKQoKCmRlZiBvbl9yYXRlKHBhcmFtKToKICAgIGdsb2JhbCBy
        YXRlCiAgICBpZiBwYXJhbToKICAgICAgICBwYXJhbSA9IHRvX2Zsb2F0KHBh
        cmFtKQogICAgICAgIGlmIHBhcmFtIGlzIE5vbmU6CiAgICAgICAgICAgIGlu
        Zm8oJ2JhZCBzYW1wbGUgcmF0ZSBjb21tYW5kJykKICAgICAgICBlbHNlOgog
        ICAgICAgICAgICByYWRpby5zZXRTYW1wbGVSYXRlKFNPQVBZX1NEUl9SWCwg
        MCwgcGFyYW0pCiAgICByYXRlID0gcmFkaW8uZ2V0U2FtcGxlUmF0ZShTT0FQ
        WV9TRFJfUlgsIDApCiAgICBicm9rZXIucHVibGlzaChnZW5fdG9waWMoInJh
        dGUiKSwgZid7cmF0ZS8xZTM6LjNmfSBLSHonKQoKCmRlZiBvbl9mcmVxKHBh
        cmFtKToKICAgIGlmIHBhcmFtOgogICAgICAgIHBhcmFtID0gdG9fZmxvYXQo
        cGFyYW0pCiAgICAgICAgaWYgcGFyYW0gaXMgTm9uZToKICAgICAgICAgICAg
        aW5mbygnYmFkIGZyZXF1ZW5jeSBjb21tYW5kJykKICAgICAgICBlbHNlOgog
        ICAgICAgICAgICByYWRpby5zZXRGcmVxdWVuY3koU09BUFlfU0RSX1JYLCAw
        LCBwYXJhbSkKICAgIGZyZXEgPSByYWRpby5nZXRGcmVxdWVuY3koU09BUFlf
        U0RSX1JYLCAwKQogICAgYnJva2VyLnB1Ymxpc2goZ2VuX3RvcGljKCJmcmVx
        IiksIGYne2ZyZXEvMWU2Oi42Zn0gTUh6JykKCgpkZWYgb25fZ2FpbihwYXJh
        bSk6CiAgICBpZiBwYXJhbToKICAgICAgICBwYXJhbSA9IHRvX2Zsb2F0KHBh
        cmFtKQogICAgICAgIGlmIHBhcmFtIGlzIE5vbmU6CiAgICAgICAgICAgIGlu
        Zm8oJ2JhZCBnYWluIGNvbW1hbmQnKQogICAgICAgIGVsc2U6CiAgICAgICAg
        ICAgIHJhZGlvLnNldEdhaW4oU09BUFlfU0RSX1JYLCAwLCBwYXJhbSkKICAg
        IGdhaW4gPSByYWRpby5nZXRHYWluKFNPQVBZX1NEUl9SWCwgMCkKICAgIGJy
        b2tlci5wdWJsaXNoKGdlbl90b3BpYygiZ2FpbiIpLCBmJ3tnYWluOi4zZ30g
        ZEInKQoKCmRlZiBvbl9hdXRvKHBhcmFtKToKICAgIGlmIHBhcmFtOgogICAg
        ICAgIHJhZGlvLnNldEdhaW5Nb2RlKFNPQVBZX1NEUl9SWCwgMCwgcGFyYW0u
        bG93ZXIoKSA9PSAidHJ1ZSIpCiAgICBhZ2MgPSByYWRpby5nZXRHYWluTW9k
        ZShTT0FQWV9TRFJfUlgsIDApCiAgICBicm9rZXIucHVibGlzaChnZW5fdG9w
        aWMoImFnYyIpLCAnb24nIGlmIGFnYyBlbHNlICdvZmYnKQoKCmRlZiBvbl9z
        ZXR0aW5nKGtleSwgcGFyYW0pOgogICAgaWYgcGFyYW06CiAgICAgICAgcmFk
        aW8ud3JpdGVTZXR0aW5nKGtleSwgcGFyYW0pCiAgICB2YWwgPSByYWRpby5y
        ZWFkU2V0dGluZyhrZXkpCiAgICBicm9rZXIucHVibGlzaChnZW5fdG9waWMo
        a2V5KSwgc3RyKHZhbCkpCgoKZGVmIG9uX3Bwcyh0cyk6CiAgICBpZiB0aW1l
        ZmlsZSBhbmQgbm90IHBhdXNlZDoKICAgICAgICBzZWMgPSBzYW1wbGVzX3Rv
        dGFsIC8gcmF0ZQogICAgICAgIGR0ID0gZGF0ZXRpbWUuc3RycHRpbWUodHMs
        ICIlWS0lbS0lZFQlSDolTTolUy4lZloiKQogICAgICAgIGlmIGR0LnNlY29u
        ZCAlIGFyZ3MucmVmZXNoX3BwcyA9PSAwOgogICAgICAgICAgICBpbmZvKHRz
        KQogICAgICAgIHRpbWVmaWxlLndyaXRlKGYie3NlYzouM2Z9XHR7c2VjOi4z
        Zn1cdHt0c31cbiIpCiAgICAgICAgdGltZWZpbGUuZmx1c2goKQoKCmRlZiBv
        bl9tZXNzYWdlKGNsaWVudCwgdXNlcmRhdGEsIG1zZyk6CiAgICBwYXlsb2Fk
        ID0gbXNnLnBheWxvYWQuZGVjb2RlKCdsYXRpbicpLnN0cmlwKCkKICAgIHRy
        eToKICAgICAgICBpZiBwYXlsb2FkIGFuZCBtc2cudG9waWMgPT0gYXJncy5w
        cHNfdG9waWM6CiAgICAgICAgICAgIG9uX3BwcyhwYXlsb2FkKQogICAgICAg
        IGlmIHBheWxvYWQgYW5kIG1zZy50b3BpYyA9PSBhcmdzLnRvcGljOgogICAg
        ICAgICAgICBjbWQsIF8sIHBhcmFtID0gcGF5bG9hZC5wYXJ0aXRpb24oJyAn
        KSAKICAgICAgICAgICAgcGFyYW0gPSBwYXJhbS5zdHJpcCgpCiAgICAgICAg
        ICAgIGlmIGNtZCA9PSAncCc6CiAgICAgICAgICAgICAgICBvbl9wYXVzZShw
        YXJhbSkKICAgICAgICAgICAgZWxpZiBjbWQgPT0gJ2cnOgogICAgICAgICAg
        ICAgICAgb25fZ2FpbihwYXJhbSkKICAgICAgICAgICAgZWxpZiBjbWQgPT0g
        J2EnOgogICAgICAgICAgICAgICAgb25fYXV0byhwYXJhbSkKICAgICAgICAg
        ICAgZWxpZiBjbWQgPT0gJ3InOgogICAgICAgICAgICAgICAgb25fcmF0ZShw
        YXJhbSkKICAgICAgICAgICAgZWxpZiBjbWQgPT0gJ2YnOgogICAgICAgICAg
        ICAgICAgb25fZnJlcShwYXJhbSkKICAgICAgICAgICAgZWxpZiBjbWQgPT0g
        J2snOgogICAgICAgICAgICAgICAgb25fa2lsbChwYXJhbSkKICAgICAgICAg
        ICAgZWxpZiBjbWQgPT0gJ0snOgogICAgICAgICAgICAgICAgb25fZmF0YWwo
        cGFyYW0pCiAgICAgICAgICAgIGVsaWYgY21kID09ICdkcyc6CiAgICAgICAg
        ICAgICAgICBpZiBwYXJhbS5sb3dlcigpID09ICJpIjogcGFyYW0gPSAiMSIK
        ICAgICAgICAgICAgICAgIGlmIHBhcmFtLmxvd2VyKCkgPT0gInEiOiBwYXJh
        bSA9ICIyIgogICAgICAgICAgICAgICAgb25fc2V0dGluZygiZGlyZWN0X3Nh
        bXAiLCBwYXJhbSkKICAgICAgICAgICAgZWxpZiBjbWQgPT0gJ2lxJzoKICAg
        ICAgICAgICAgICAgIG9uX3NldHRpbmcoImlxX3N3YXAiLCBwYXJhbSkKICAg
        ICAgICAgICAgZWxpZiBjbWQgPT0gJ2J0JzoKICAgICAgICAgICAgICAgIG9u
        X3NldHRpbmcoImJpYXN0ZWUiLCBwYXJhbSkKICAgICAgICAgICAgZWxpZiBj
        bWQgPT0gJ2RhJzoKICAgICAgICAgICAgICAgIG9uX3NldHRpbmcoImRpZ2l0
        YWxfYWdjIiwgcGFyYW0pCiAgICAgICAgICAgIGVsaWYgY21kID09ICdvdCc6
        CiAgICAgICAgICAgICAgICBvbl9zZXR0aW5nKCJvZmZzZXRfdHVuZSIsIHBh
        cmFtKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgaW5mbygn
        dW5rbm93biBjb21tYW5kJykKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToK
        ICAgICAgICBpbmZvKGYiRXhjZXB0aW9uIG9uX21lc3NhZ2UoKToge2V9IikK
        CgpkZWYgb25fY29ubmVjdChjbGllbnQsIHVzZXJkYXRhLCBmbGFncywgcmMp
        OgogICAgY2xpZW50LnN1YnNjcmliZShnZW5fdG9waWMoJyMnKSkKICAgIGNs
        aWVudC5zdWJzY3JpYmUoYXJncy5wcHNfdG9waWMpCgoKIyMjIyMjIyMjIyMj
        IyMjMwoKCmRlZiBpbmZvKHBheWxvYWQpOgogICAgcHJpbnQocGF5bG9hZCwg
        ZmlsZT1zeXMuc3RkZXJyKQogICAgaWYgYnJva2VyOgogICAgICAgIGJyb2tl
        ci5wdWJsaXNoKGdlbl90b3BpYygiaW5mbyIpLCBwYXlsb2FkKQoKCmRlZiBs
        b2dfaGFuZGxlcihsb2dfbGV2ZWwsIGxvZ19tZXNzYWdlKToKICAgIGlmIGJy
        b2tlcjoKICAgICAgICBicm9rZXIucHVibGlzaChnZW5fdG9waWMoImxvZyIp
        LCBsb2dfbWVzc2FnZSkKCgpkZWYgd2F2X2hlYWRlcihyYXRlLCBjaGFubmVs
        cz0yLCBzYW1wbGVfYnl0ZXM9NCk6CiAgICByYXRlID0gaW50KHJhdGUpCiAg
        ICBkYXRhX2lkID0gYidkYXRhJwogICAgZGF0YV9zaXplID0gMHg4MDAwMDAw
        MAogICAgcmlmZl9pZCA9IGInUklGRicKICAgIHJpZmZfZm9ybWF0ID0gYidX
        QVZFJwogICAgZm10X2lkID0gYidmbXQgJwogICAgZm10X3NpemUgPSAxNgog
        ICAgZm10X2Zvcm1hdCA9IDMgICAgIyBJRUVFX0ZMT0FUCiAgICBidWYgPSBz
        dHJ1Y3QucGFjaygnPDRzSTRzJywgcmlmZl9pZCwgZGF0YV9zaXplICsgMjAg
        KyBmbXRfc2l6ZSwgcmlmZl9mb3JtYXQpCiAgICBidWYgKz0gc3RydWN0LnBh
        Y2soJzw0c0lISCcsIGZtdF9pZCwgZm10X3NpemUsIGZtdF9mb3JtYXQsIGNo
        YW5uZWxzKQogICAgYnVmICs9IHN0cnVjdC5wYWNrKCc8SUlISCcsCiAgICAg
        ICAgcmF0ZSwgICAgICAgICAgICAgICAgICAgICAgICAgICAjIDMyLWJpdAog
        ICAgICAgIHJhdGUgKiBjaGFubmVscyAqIHNhbXBsZV9ieXRlcywgIyAzMi1i
        aXQKICAgICAgICBjaGFubmVscyAqIHNhbXBsZV9ieXRlcywKICAgICAgICBz
        YW1wbGVfYnl0ZXMgKiA4KQogICAgYnVmICs9IHN0cnVjdC5wYWNrKCc8NHNJ
        JywgZGF0YV9pZCwgZGF0YV9zaXplKQogICAgcmV0dXJuIGJ1ZgoKCmRlZiBy
        YWRpb19jb25uZWN0KCk6CiAgICBnbG9iYWwgcmFkaW8KICAgIGRyaXZlcnMg
        PSBbIGRbJ2RyaXZlciddIGZvciBkIGluIFNvYXB5U0RSLkRldmljZS5lbnVt
        ZXJhdGUoKSBdCiAgICBpbmZvKGYiRm91bmQgZHJpdmVyczoge2RyaXZlcnN9
        IikKICAgIGt3ID0ge30KICAgIGlmIGFyZ3MuZHJpdmVyOgogICAgICAgIGt3
        Wydkcml2ZXInXSA9IGFyZ3MuZHJpdmVyCiAgICBpbmZvKGYiUGFzc2luZyB0
        aGUgZm9sbG93aW5nIGFyZ3VtZW50czoge2t3fSIpCiAgICByYWRpbyA9IFNv
        YXB5U0RSLkRldmljZShrdykKCgpkZWYgcmFkaW9fc2V0dGluZ3MoKToKICAg
        IGluZm8oZiJJbml0aWFsaXppbmcgcmFkaW8gc2V0dGluZ3MiKQogICAgaWYg
        YXJncy5mcmVxOgogICAgICAgIHJhZGlvLnNldEZyZXF1ZW5jeShTT0FQWV9T
        RFJfUlgsIDAsIGFyZ3MuZnJlcSkKICAgIGlmIGFyZ3MucmF0ZToKICAgICAg
        ICByYWRpby5zZXRTYW1wbGVSYXRlKFNPQVBZX1NEUl9SWCwgMCwgYXJncy5y
        YXRlKQogICAgcmFkaW8uc2V0R2Fpbk1vZGUoU09BUFlfU0RSX1JYLCAwLCBh
        cmdzLmFnYyk7CiAgICBpZiBhcmdzLmdhaW46CiAgICAgICAgcmFkaW8uc2V0
        R2FpbihTT0FQWV9TRFJfUlgsIDAsIGFyZ3MuZ2FpbikKICAgIGlmIGFyZ3Mu
        ZGlyZWN0X3NhbXA6CiAgICAgICAgcGFyYW0gPSBhcmdzLmRpcmVjdF9zYW1w
        CiAgICAgICAgaWYgcGFyYW0ubG93ZXIoKSA9PSAiaSI6IHBhcmFtID0gIjEi
        CiAgICAgICAgaWYgcGFyYW0ubG93ZXIoKSA9PSAicSI6IHBhcmFtID0gIjIi
        CiAgICAgICAgcmFkaW8ud3JpdGVTZXR0aW5nKCJkaXJlY3Rfc2FtcCIsIHBh
        cmFtKQogICAgaWYgYXJncy5pcV9zd2FwOgogICAgICAgIHJhZGlvLndyaXRl
        U2V0dGluZygiaXFfc3dhcCIsICJ0cnVlIikKICAgIGlmIGFyZ3MuYmlhc3Rl
        ZToKICAgICAgICByYWRpby53cml0ZVNldHRpbmcoImJpYXN0ZWUiLCAidHJ1
        ZSIpCiAgICBpZiBhcmdzLmRpZ2l0YWxfYWdjOgogICAgICAgIHJhZGlvLndy
        aXRlU2V0dGluZygiZGlnaXRhbF9hZ2MiLCAidHJ1ZSIpCiAgICBpZiBhcmdz
        LmRpZ2l0YWxfYWdjOgogICAgICAgIHJhZGlvLndyaXRlU2V0dGluZygib2Zm
        c2V0X3R1bmUiLCAidHJ1ZSIpCgoKZGVmIG1haW5faW5pdCgpOgogICAgZ2xv
        YmFsIHBhdXNlZCwga2lsbGVkLCBmYXRhbAogICAga2lsbGVkID0gRmFsc2UK
        ICAgIGZhdGFsID0gRmFsc2UKICAgIHBhdXNlZCA9IGFyZ3MucGF1c2UKCgpk
        ZWYgYnJva2VyX2luaXQoKToKICAgIGdsb2JhbCBicm9rZXIsIHRpbWVmaWxl
        CiAgICB0aW1lZmlsZSA9IE5vbmUKICAgIGJyb2tlciA9IE5vbmUKICAgIGlm
        IG5vdCBhcmdzLm5vYnJva2VyOgogICAgICAgIGluZm8oZiJDb25uZWN0aW5n
        IHRvIGJyb2tlcjoge2FyZ3MuYnJva2VyfSIpCiAgICAgICAgYnJva2VyID0g
        bXF0dC5DbGllbnQoKQogICAgICAgIGJyb2tlci5vbl9jb25uZWN0ID0gb25f
        Y29ubmVjdAogICAgICAgIGJyb2tlci5vbl9tZXNzYWdlID0gb25fbWVzc2Fn
        ZQogICAgICAgIGJyb2tlci5jb25uZWN0KGFyZ3MuYnJva2VyLCBhcmdzLnBv
        cnQsIGFyZ3Mua2VlcGFsaXZlKQogICAgICAgIGJyb2tlci5sb29wX3N0YXJ0
        KCkKCgpkZWYgbWFpbigpOgogICAgYnJva2VyX2luaXQoKQogICAgU29hcHlT
        RFIucmVnaXN0ZXJMb2dIYW5kbGVyKGxvZ19oYW5kbGVyKQogICAgaW5pdGlh
        bGl6ZWQ9IEZhbHNlCiAgICB3aGlsZSBUcnVlOgogICAgICAgIHRyeToKICAg
        ICAgICAgICAgbWFpbl9pbml0KCkKICAgICAgICAgICAgcmFkaW9fY29ubmVj
        dCgpCiAgICAgICAgICAgIGlmIG5vdCBpbml0aWFsaXplZDoKICAgICAgICAg
        ICAgICAgIHJhZGlvX3NldHRpbmdzKCkKICAgICAgICAgICAgaW5pdGlhbGl6
        ZWQgPSBUcnVlCiAgICAgICAgICAgIHJhZGlvX3N0YXJ0KCkKICAgICAgICBl
        eGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGluZm8oZiJFeGNl
        cHRpb24gbWFpbigpOiB7ZX0iKQogICAgICAgICAgICB0aW1lLnNsZWVwKHJl
        c3RhcnRfc2Vjb25kcykKCgpkZWYgY2xvc2VfZmlsZShmLCBuYW1lKToKICAg
        IGlmIGY6CiAgICAgICAgaW5mbyhmIkNsb3Npbmcge25hbWV9IGZpbGUuIikK
        ICAgICAgICBmLmNsb3NlKCkKCgpkZWYgb3Blbl9maWxlcygpOgogICAgZHQg
        PSBkYXRldGltZS51dGNub3coKQogICAgdHMgPSBkdC5zdHJmdGltZSgnJXkl
        bSVkXyVIJU0lUycpCiAgICBmcmVxID0gcmFkaW8uZ2V0RnJlcXVlbmN5KFNP
        QVBZX1NEUl9SWCwgMCkKICAgIGJhc2VuYW1lID0gZiJ7YXJncy5vdXRwdXR9
        X3t0c31aX3tmcmVxLzFlNjouNmZ9TUh6IgogICAgZXh0ID0gJ3R4dCcKICAg
        IGZpbGVuYW1lID0gZiJ7YmFzZW5hbWV9LntleHR9IgogICAgaW5mbyhmIk9w
        ZW5pbmcge2ZpbGVuYW1lfSBmb3IgZ3BzIHBwcyB0aW1lIikKICAgIHRpbWVm
        aWxlID0gb3BlbihmaWxlbmFtZSwgInciKQogICAgZXh0ID0gJ3JhdycgaWYg
        YXJncy5ub3dhdmUgZWxzZSAnd2F2JwogICAgZmlsZW5hbWUgPSBmIntiYXNl
        bmFtZX0ue2V4dH0iCiAgICBpbmZvKGYiT3BlbmluZyB7ZmlsZW5hbWV9IGZv
        ciBhdWRpbyIpCiAgICBhdWRpb2ZpbGUgPSBvcGVuKGZpbGVuYW1lLCAid2Ii
        KQogICAgaWYgbm90IGFyZ3Mubm93YXZlOgogICAgICAgIGF1ZGlvZmlsZS53
        cml0ZSh3YXZfaGVhZGVyKHJhdGU9cmF0ZSkpCiAgICByZXR1cm4gYXVkaW9m
        aWxlLCB0aW1lZmlsZQoKCmRlZiBjbG9zZV9zdHJlYW0oc3RyZWFtKToKICAg
        IGluZm8oZiJDbG9zaW5nIHJhZGlvIHN0cmVhbS4iKQogICAgcmFkaW8uZGVh
        Y3RpdmF0ZVN0cmVhbShzdHJlYW0pIAogICAgcmFkaW8uY2xvc2VTdHJlYW0o
        c3RyZWFtKQoKCmRlZiByYWRpb19wZWFrKHBlYWtfbGV2ZWwpOgogICAgZGIg
        PSAiezouMWZ9IGRCIi5mb3JtYXQoMjAgKiBucC5sb2cxMChwZWFrX2xldmVs
        ICsgMWUtOTkpKQogICAgaWYgYXJncy5tZXRlcjoKICAgICAgICBidWYgPSBm
        IntkYn1cbiIgaWYgYXJncy5kdW1iIGVsc2UgZiJcMzNbMkt7ZGI6PjlzfVxy
        IgogICAgICAgIHByaW50KGJ1ZiwgZW5kPSIiLCBmaWxlPXN5cy5zdGRlcnIp
        CiAgICBpZiBicm9rZXI6CiAgICAgICAgYnJva2VyLnB1Ymxpc2goZ2VuX3Rv
        cGljKCJwZWFrIiksIGRiKQoKCmRlZiByYWRpb19zdGFydCgpOgogICAgZ2xv
        YmFsIHJhdGUsIHRpbWVmaWxlLCBzYW1wbGVzX3RvdGFsCiAgICByYXRlID0g
        cmFkaW8uZ2V0U2FtcGxlUmF0ZShTT0FQWV9TRFJfUlgsIDApCiAgICBzaXpl
        ID0gYXJncy5wYWNrZXRfc2l6ZQogICAgZGF0YSA9IG5wLmFycmF5KFswXSAq
        IHNpemUgKiAyLCBucC5mbG9hdDMyKQogICAgc3RyZWFtID0gcmFkaW8uc2V0
        dXBTdHJlYW0oU09BUFlfU0RSX1JYLCBTT0FQWV9TRFJfQ0YzMikKICAgIHJh
        ZGlvLmFjdGl2YXRlU3RyZWFtKHN0cmVhbSkgCiAgICBzYW1wbGVzX3RvdGFs
        ID0gMAogICAgcGVha19sZXZlbCA9IDAKICAgIHNhbXBsZV9udW0gPSAwCiAg
        ICBvdXRmaWxlID0gTm9uZQogICAgdHJ5OgogICAgICAgIHdoaWxlIG5vdCBr
        aWxsZWQgYW5kIG5vdCBmYXRhbDoKICAgICAgICAgICAgcmFkaW8ucmVhZFN0
        cmVhbShzdHJlYW0sIFtkYXRhXSwgc2l6ZSkKICAgICAgICAgICAgaWYgbm90
        IHBhdXNlZDoKICAgICAgICAgICAgICAgIGlmIG5vdCBvdXRmaWxlOgogICAg
        ICAgICAgICAgICAgICAgIG91dGZpbGUsIHRpbWVmaWxlID0gb3Blbl9maWxl
        cygpCiAgICAgICAgICAgICAgICBzYW1wbGVzX3RvdGFsICs9IHNpemUKICAg
        ICAgICAgICAgICAgIG91dGZpbGUud3JpdGUoZGF0YSkKICAgICAgICAgICAg
        cGVha19sZXZlbCA9IG1heChwZWFrX2xldmVsLCBhYnMoZGF0YS5taW4oKSks
        IGFicyhkYXRhLm1heCgpKSkKICAgICAgICAgICAgc2FtcGxlX251bSArPSBz
        aXplCiAgICAgICAgICAgIGlmIHNhbXBsZV9udW0gPiByYXRlICogYXJncy5y
        ZWZyZXNoOgogICAgICAgICAgICAgICAgcmFkaW9fcGVhayhwZWFrX2xldmVs
        KQogICAgICAgICAgICAgICAgcGVha19sZXZlbCA9IDAKICAgICAgICAgICAg
        ICAgIHNhbXBsZV9udW0gPSAwCiAgICBleGNlcHQgKEtleWJvYXJkSW50ZXJy
        dXB0LCBTeXN0ZW1FcnJvcikgYXMgZToKICAgICAgICBpbmZvKGYiRXhjZXB0
        aW9uIHJhZGlvX3N0YXJ0KCk6IHtlfSIpCiAgICBjbG9zZV9maWxlKG91dGZp
        bGUsICJhdWRpbyIpCiAgICB0aW1lZmlsZSA9IGNsb3NlX2ZpbGUodGltZWZp
        bGUsICJ0aW1lIikKICAgIGNsb3NlX3N0cmVhbShzdHJlYW0pCiAgICBpZiBm
        YXRhbDoKICAgICAgICBpbmZvKCJGYXRhbCBjb21tYW5kIGdpdmVuLCBraWxs
        aW5nIHByb2Nlc3MiKQogICAgICAgIHN5cy5leGl0KDEpCgoKaWYgX19uYW1l
        X18gPT0gJ19fbWFpbl9fJzoKICAgIGFyZ3MgPSBwYXJzZXIucGFyc2VfYXJn
        cygpCiAgICBtYWluKCkKCg==


  - become: yes
    copy:
      mode: 0755
      dest: /usr/local/bin/mqclient
      content: !!binary |
        IyEvdXNyL2Jpbi9weXRob24zCgppbXBvcnQgc3lzCmltcG9ydCBhcmdwYXJz
        ZQppbXBvcnQgcGFoby5tcXR0LmNsaWVudCBhcyBtcXR0CgpwYXJzZXIgPSBh
        cmdwYXJzZS5Bcmd1bWVudFBhcnNlcigKICAgIGZvcm1hdHRlcl9jbGFzcz1h
        cmdwYXJzZS5Bcmd1bWVudERlZmF1bHRzSGVscEZvcm1hdHRlcikKcGFyc2Vy
        LmFkZF9hcmd1bWVudCgiLS1icm9rZXIiLCBkZWZhdWx0PSIxMjcuMC4wLjEi
        LCBoZWxwPSdicm9rZXIgaG9zdCcpCnBhcnNlci5hZGRfYXJndW1lbnQoIi0t
        cG9ydCIsIGRlZmF1bHQ9MTg4MywgaGVscD0nYnJva2VyIHBvcnQnKQpwYXJz
        ZXIuYWRkX2FyZ3VtZW50KCItLWtlZXBhbGl2ZSIsIGRlZmF1bHQ9NjAsIGhl
        bHA9J2Jyb2tlciBrZWVwIGFsaXZlJykKcGFyc2VyLmFkZF9hcmd1bWVudCgi
        LS10b3BpYyIsIGRlZmF1bHQ9ImYvdHgiLCBoZWxwPSdjb21tYW5kIHRvcGlj
        JykKCmRlZiBvbl9jb25uZWN0KGNsaWVudCwgdXNlcmRhdGEsIGZsYWdzLCBy
        Yyk6CiAgICBjbGllbnQuc3Vic2NyaWJlKCIjIikKCmRlZiBvbl9tZXNzYWdl
        KGNsaWVudCwgdXNlcmRhdGEsIG1zZyk6CiAgICBwcmludChtc2cudG9waWMg
        KyAiICIgKyBtc2cucGF5bG9hZC5kZWNvZGUoJ2xhdGluJykpCgpkZWYgbWFp
        bigpOgogICAgY2xpZW50ID0gbXF0dC5DbGllbnQoKQogICAgY2xpZW50Lm9u
        X2Nvbm5lY3QgPSBvbl9jb25uZWN0CiAgICBjbGllbnQub25fbWVzc2FnZSA9
        IG9uX21lc3NhZ2UKICAgIGNsaWVudC5jb25uZWN0KGFyZ3MuYnJva2VyLCBh
        cmdzLnBvcnQsIGFyZ3Mua2VlcGFsaXZlKQogICAgY2xpZW50Lmxvb3Bfc3Rh
        cnQoKQogICAgd2hpbGUgVHJ1ZToKICAgICAgICBsaW5lID0gbmV4dChzeXMu
        c3RkaW4pLnJzdHJpcCgpCiAgICAgICAgY2xpZW50LnB1Ymxpc2goYXJncy50
        b3BpYywgbGluZSkgCgppZiBfX25hbWVfXyA9PSAnX19tYWluX18nOgogICAg
        YXJncyA9IHBhcnNlci5wYXJzZV9hcmdzKCkKICAgIG1haW4oKQoKCg==



  # output directory

  - become: yes
    file: path={{ fs_path }} state=directory owner={{ user }} group={{ user }}

  - become: yes
    copy:
      dest: /lib/systemd/system/mqproxy.service
      content: |
        [Service]
        ExecStart=/usr/bin/python3 -u /usr/local/bin/mqproxy
        Restart=on-failure
        RestartSec=10s
        [Install]
        WantedBy=multi-user.target

  - become: yes
    copy:
      dest: /lib/systemd/system/mqsoapy.service
      content: |
        [Service]
        ExecStart=/usr/bin/python3 -u /usr/local/bin/mqsoapy --pause --output {{ fs_path }}/out
        # WorkingDirectory={{ fs_path }}
        User=george
        Restart=on-failure
        RestartSec=10s
        [Install]
        WantedBy=multi-user.target

  - become: yes
    shell: |
      sudo systemctl enable mqproxy
      sudo systemctl enable mqsoapy

  - become: yes
    shell: |
      sudo systemctl restart mqproxy
      sudo systemctl restart mqsoapy

