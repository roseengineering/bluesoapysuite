---
  - set_fact:
      fs_path: "{{ fs_path | default('/srv') }}"

  # apt

  - become: yes
    apt:
      name:
      - mosquitto

  # pip

  - become: yes
    pip:
      name:
      - paho-mqtt

  # code

  - become: yes
    copy:
      mode: 0755
      dest: /usr/local/bin/mqsoapy
      content: !!binary |
        IyEvdXNyL2Jpbi9weXRob24zCgppbXBvcnQgb3MsIHN5cywgdGltZQppbXBv
        cnQgc29ja2V0LCBzZWxlY3QKaW1wb3J0IHN0cnVjdAppbXBvcnQgYXJncGFy
        c2UKaW1wb3J0IG51bXB5IGFzIG5wCmltcG9ydCBwYWhvLm1xdHQuY2xpZW50
        IGFzIG1xdHQKaW1wb3J0IFNvYXB5U0RSCmZyb20gZGF0ZXRpbWUgaW1wb3J0
        IGRhdGV0aW1lCmZyb20gU29hcHlTRFIgaW1wb3J0IFNPQVBZX1NEUl9SWCwg
        U09BUFlfU0RSX0NGMzIKCnJlc3RhcnRfc2Vjb25kcyA9IDEwCgpwYXJzZXIg
        PSBhcmdwYXJzZS5Bcmd1bWVudFBhcnNlcigKICAgIGZvcm1hdHRlcl9jbGFz
        cz1hcmdwYXJzZS5Bcmd1bWVudERlZmF1bHRzSGVscEZvcm1hdHRlcikKCiMg
        YnJva2VyCnBhcnNlci5hZGRfYXJndW1lbnQoIi0tYnJva2VyIiwgZGVmYXVs
        dD0iMTI3LjAuMC4xIiwgaGVscD0nYnJva2VyIGhvc3QnKQpwYXJzZXIuYWRk
        X2FyZ3VtZW50KCItLWJyb2tlci1wb3J0IiwgZGVmYXVsdD0xODgzLCB0eXBl
        PWludCwgaGVscD0nYnJva2VyIHBvcnQnKQpwYXJzZXIuYWRkX2FyZ3VtZW50
        KCItLWJyb2tlci1rZWVwYWxpdmUiLCBkZWZhdWx0PTYwLCB0eXBlPWludCwg
        aGVscD0nYnJva2VyIGtlZXBhbGl2ZSBzZWNvbmRzJykKcGFyc2VyLmFkZF9h
        cmd1bWVudCgiLS10b3BpYyIsIGRlZmF1bHQ9ImYvdHgiLCBoZWxwPSdtcXR0
        IHRvcGljIGZvciBjb21tYW5kJykKcGFyc2VyLmFkZF9hcmd1bWVudCgiLS1w
        cHMtdG9waWMiLCBkZWZhdWx0PSJwcHMiLCBoZWxwPSdtcXR0IHRvcGljIGZv
        ciBncHMgcHBzIHRpbWUnKQpwYXJzZXIuYWRkX2FyZ3VtZW50KCItLW5vYnJv
        a2VyIiwgYWN0aW9uPSJzdG9yZV90cnVlIiwgaGVscD0iZGlzYWJsZSBtcXR0
        IGJyb2tlciIpCnBhcnNlci5hZGRfYXJndW1lbnQoIi0tcmVmcmVzaC1wcHMi
        LCBkZWZhdWx0PTEwLCB0eXBlPWludCwgaGVscD0ncHBzIHJlZnJlc2ggaW4g
        c2Vjb25kcycpCgojIHNvYXB5CnBhcnNlci5hZGRfYXJndW1lbnQoIi0tZHJp
        dmVyIiwgaGVscD0nbmFtZSBvZiBkcml2ZXInKQpwYXJzZXIuYWRkX2FyZ3Vt
        ZW50KCItLXBhY2tldC1zaXplIiwgZGVmYXVsdD0xMDI0LCB0eXBlPWludCwg
        aGVscD0ncGFja2V0IHNpemUnKQpwYXJzZXIuYWRkX2FyZ3VtZW50KCItLWZy
        ZXEiLCB0eXBlPW5wLmZsb2F0LCBoZWxwPSJjZW50ZXIgZnJlcXVlbmN5IGlu
        IGhlcnR6IikKcGFyc2VyLmFkZF9hcmd1bWVudCgiLS1yYXRlIiwgdHlwZT1u
        cC5mbG9hdCwgaGVscD0ic2FtcGxlIHJhdGUgaW4gaGVydHoiKQpwYXJzZXIu
        YWRkX2FyZ3VtZW50KCItLWdhaW4iLCB0eXBlPW5wLmZsb2F0LCBoZWxwPSJm
        cm9udCBlbmQgZ2FpbiBpbiBkQiIpCnBhcnNlci5hZGRfYXJndW1lbnQoIi0t
        YWdjIiwgYWN0aW9uPSJzdG9yZV90cnVlIiwgaGVscD0iZW5hYmxlIEFHQyIp
        CgojIHNvYXB5IGFyZ1N0cmluZwpwYXJzZXIuYWRkX2FyZ3VtZW50KCItLWRp
        cmVjdC1zYW1wIiwgaGVscD0iMD1vZmYsIDEgb3IgaT1JLCAyIG9yIHE9USBj
        aGFubmVsIikKcGFyc2VyLmFkZF9hcmd1bWVudCgiLS1pcS1zd2FwIiwgYWN0
        aW9uPSJzdG9yZV90cnVlIiwgaGVscD0ic3dhcCBJUSBzaWduYWxzIikKcGFy
        c2VyLmFkZF9hcmd1bWVudCgiLS1iaWFzdGVlIiwgYWN0aW9uPSJzdG9yZV90
        cnVlIiwgaGVscD0iZW5hYmxlIGJpYXMgdGVlIikKcGFyc2VyLmFkZF9hcmd1
        bWVudCgiLS1kaWdpdGFsLWFnYyIsIGFjdGlvbj0ic3RvcmVfdHJ1ZSIsIGhl
        bHA9ImVuYWJsZSBkaWdpdGFsIEFHQyIpCnBhcnNlci5hZGRfYXJndW1lbnQo
        Ii0tb2Zmc2V0LXR1bmUiLCBhY3Rpb249InN0b3JlX3RydWUiLCBoZWxwPSJl
        bmFibGUgb2Zmc2V0IHR1bmUiKQoKIyBvdGhlcgpwYXJzZXIuYWRkX2FyZ3Vt
        ZW50KCItLW91dHB1dCIsIGRlZmF1bHQ9Im91dCIsIGhlbHA9IndyaXRlIENG
        MzIgc2FtcGxlcyB0byBmaWxlIikKcGFyc2VyLmFkZF9hcmd1bWVudCgiLS1u
        b3dhdmUiLCBhY3Rpb249InN0b3JlX3RydWUiLCBoZWxwPSJkaXNhYmxlIFdB
        ViBoZWFkZXIiKQpwYXJzZXIuYWRkX2FyZ3VtZW50KCItLXBhdXNlIiwgYWN0
        aW9uPSJzdG9yZV90cnVlIiwgaGVscD0icGF1c2Ugb3V0cHV0IikKCiMgcGVh
        ayBtZXRlcgpwYXJzZXIuYWRkX2FyZ3VtZW50KCItLXJlZnJlc2giLCBkZWZh
        dWx0PTUsIHR5cGU9aW50LCBoZWxwPSJwZWFrIG1ldGVyIHJlZnJlc2ggaW4g
        c2Vjb25kcyIpCnBhcnNlci5hZGRfYXJndW1lbnQoIi0tbWV0ZXIiLCBhY3Rp
        b249InN0b3JlX3RydWUiLCBoZWxwPSJlbmFibGUgY29uc29sZSBwZWFrIG1l
        dGVyIikKcGFyc2VyLmFkZF9hcmd1bWVudCgiLS1kdW1iIiwgYWN0aW9uPSJz
        dG9yZV90cnVlIiwgaGVscD0iZW5hYmxlIGR1bWIgdGVybWluYWwgY29uc29s
        ZSIpCiAKIyB0Y3Agc2VydmVyCnBhcnNlci5hZGRfYXJndW1lbnQoIi0taG9z
        dCIsIGRlZmF1bHQ9IjEyNy4wLjAuMSIsIGhlbHA9IkNGMzIgdGNwIHNlcnZl
        ciBob3N0IGFkZHJlc3MiKQpwYXJzZXIuYWRkX2FyZ3VtZW50KCItLXBvcnQi
        LCB0eXBlPWludCwgZGVmYXVsdD0xMjM0LCBoZWxwPSJDRjMyIHRjcCBzZXJ2
        ZXIgcG9ydCBhZGRyZXNzIikKcGFyc2VyLmFkZF9hcmd1bWVudCgiLS1ydGx0
        Y3AiLCBhY3Rpb249InN0b3JlX3RydWUiLCBoZWxwPSJlbmFibGUgQ1U4IHJ0
        bHRjcCBzZXJ2ZXIgbW9kZSIpCnBhcnNlci5hZGRfYXJndW1lbnQoIi0tbm9z
        ZXJ2ZXIiLCBhY3Rpb249InN0b3JlX3RydWUiLCBoZWxwPSJkaXNhYmxlIHRj
        cCBzZXJ2ZXIiKQoKCgpkZWYgZ2VuX3RvcGljKG5hbWU9Tm9uZSk6CiAgICBk
        ID0gYXJncy50b3BpYy5zcGxpdCgnLycpWzotMV0KICAgIGlmIG5hbWUgaXMg
        bm90IE5vbmU6CiAgICAgICAgZC5hcHBlbmQobmFtZSkKICAgIHJldHVybiAn
        Lycuam9pbihkKQoKCmRlZiB0b19mbG9hdChwYXJhbSk6CiAgICB0cnk6CiAg
        ICAgICAgcmV0dXJuIGZsb2F0KHBhcmFtKQogICAgZXhjZXB0IFZhbHVlRXJy
        b3I6CiAgICAgICAgcGFzcwoKIyMjCgpkZWYgb25faW5mbyhwYXJhbSk6CiAg
        ICBjaGFuID0gMAogICAgZm9yIHIgaW4gcmFkaW8uZ2V0U2FtcGxlUmF0ZVJh
        bmdlKFNPQVBZX1NEUl9SWCwgY2hhbik6CiAgICAgICBwYXlsb2FkID0gJ3Jh
        dGU6IHs6LjNmfSBLSHonLmZvcm1hdChyLm1pbmltdW0oKSAvIDFlMykKICAg
        ICAgIGluZm8ocGF5bG9hZCkKICAgIGZvciByIGluIHJhZGlvLmdldEZyZXF1
        ZW5jeVJhbmdlKFNPQVBZX1NEUl9SWCwgY2hhbik6CiAgICAgICBwYXlsb2Fk
        ID0gJ2ZyZXE6IHs6LjZmfSAtIHs6LjZmfSBNSHonLmZvcm1hdCgKICAgICAg
        ICAgICByLm1pbmltdW0oKSAvIDFlNiwgci5tYXhpbXVtKCkgLyAxZTYpCiAg
        ICAgICBpbmZvKHBheWxvYWQpCiAgICByID0gcmFkaW8uZ2V0R2FpblJhbmdl
        KFNPQVBZX1NEUl9SWCwgY2hhbikKICAgIHBheWxvYWQgPSAnZ2Fpbjogezou
        MmZ9IC0gezouMmZ9IGRCJy5mb3JtYXQoci5taW5pbXVtKCksIHIubWF4aW11
        bSgpKQogICAgaW5mbyhwYXlsb2FkKQoKCmRlZiBvbl9mYXRhbChwYXJhbSk6
        CiAgICBnbG9iYWwgZmF0YWwKICAgIGlmIHBhcmFtLmxvd2VyKCkgPT0gInRy
        dWUiOgogICAgICAgIGZhdGFsID0gVHJ1ZQogICAgICAgIGluZm8oJ2ZhdGFs
        IGtpbGxpbmcnKQogICAgZWxzZToKICAgICAgICBpbmZvKCdiYWQgZmF0YWwg
        Y29tbWFuZCcpCgoKZGVmIG9uX2tpbGwocGFyYW0pOgogICAgZ2xvYmFsIGtp
        bGxlZAogICAgaWYgcGFyYW0ubG93ZXIoKSA9PSAidHJ1ZSI6CiAgICAgICAg
        a2lsbGVkID0gVHJ1ZQogICAgICAgIGluZm8oJ2tpbGxpbmcgc3RyZWFtJykK
        ICAgIGVsc2U6CiAgICAgICAgaW5mbygnYmFkIGtpbGwgY29tbWFuZCcpCgoK
        ZGVmIG9uX3BhdXNlKHBhcmFtKToKICAgIGdsb2JhbCBwYXVzZWQKICAgIGlm
        IHBhcmFtOgogICAgICAgIHBhdXNlZCA9IHBhcmFtLmxvd2VyKCkgPT0gInRy
        dWUiCiAgICBicm9rZXIucHVibGlzaChnZW5fdG9waWMoInBhdXNlIiksICdv
        bicgaWYgcGF1c2VkIGVsc2UgJ29mZicpCgoKZGVmIG9uX3JhdGUocGFyYW0p
        OgogICAgZ2xvYmFsIHJhdGUKICAgIGlmIHBhcmFtOgogICAgICAgIHBhcmFt
        ID0gdG9fZmxvYXQocGFyYW0pCiAgICAgICAgaWYgcGFyYW0gaXMgTm9uZToK
        ICAgICAgICAgICAgaW5mbygnYmFkIHNhbXBsZSByYXRlIGNvbW1hbmQnKQog
        ICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhZGlvLnNldFNhbXBsZVJhdGUo
        U09BUFlfU0RSX1JYLCAwLCBwYXJhbSkKICAgIHJhdGUgPSByYWRpby5nZXRT
        YW1wbGVSYXRlKFNPQVBZX1NEUl9SWCwgMCkKICAgIGJyb2tlci5wdWJsaXNo
        KGdlbl90b3BpYygicmF0ZSIpLCBmJ3tyYXRlLzFlMzouM2Z9IEtIeicpCgoK
        ZGVmIG9uX2ZyZXEocGFyYW0pOgogICAgaWYgcGFyYW06CiAgICAgICAgcGFy
        YW0gPSB0b19mbG9hdChwYXJhbSkKICAgICAgICBpZiBwYXJhbSBpcyBOb25l
        OgogICAgICAgICAgICBpbmZvKCdiYWQgZnJlcXVlbmN5IGNvbW1hbmQnKQog
        ICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhZGlvLnNldEZyZXF1ZW5jeShT
        T0FQWV9TRFJfUlgsIDAsIHBhcmFtKQogICAgZnJlcSA9IHJhZGlvLmdldEZy
        ZXF1ZW5jeShTT0FQWV9TRFJfUlgsIDApCiAgICBicm9rZXIucHVibGlzaChn
        ZW5fdG9waWMoImZyZXEiKSwgZid7ZnJlcS8xZTY6LjZmfSBNSHonKQoKCmRl
        ZiBvbl9nYWluKHBhcmFtKToKICAgIGlmIHBhcmFtOgogICAgICAgIHBhcmFt
        ID0gdG9fZmxvYXQocGFyYW0pCiAgICAgICAgaWYgcGFyYW0gaXMgTm9uZToK
        ICAgICAgICAgICAgaW5mbygnYmFkIGdhaW4gY29tbWFuZCcpCiAgICAgICAg
        ZWxzZToKICAgICAgICAgICAgcmFkaW8uc2V0R2FpbihTT0FQWV9TRFJfUlgs
        IDAsIHBhcmFtKQogICAgZ2FpbiA9IHJhZGlvLmdldEdhaW4oU09BUFlfU0RS
        X1JYLCAwKQogICAgYnJva2VyLnB1Ymxpc2goZ2VuX3RvcGljKCJnYWluIiks
        IGYne2dhaW46LjNnfSBkQicpCgoKZGVmIG9uX2F1dG8ocGFyYW0pOgogICAg
        aWYgcGFyYW06CiAgICAgICAgcmFkaW8uc2V0R2Fpbk1vZGUoU09BUFlfU0RS
        X1JYLCAwLCBwYXJhbS5sb3dlcigpID09ICJ0cnVlIikKICAgIGFnYyA9IHJh
        ZGlvLmdldEdhaW5Nb2RlKFNPQVBZX1NEUl9SWCwgMCkKICAgIGJyb2tlci5w
        dWJsaXNoKGdlbl90b3BpYygiYWdjIiksICdvbicgaWYgYWdjIGVsc2UgJ29m
        ZicpCgoKZGVmIG9uX3NldHRpbmcoa2V5LCBwYXJhbSk6CiAgICBpZiBwYXJh
        bToKICAgICAgICByYWRpby53cml0ZVNldHRpbmcoa2V5LCBwYXJhbSkKICAg
        IHZhbCA9IHJhZGlvLnJlYWRTZXR0aW5nKGtleSkKICAgIGJyb2tlci5wdWJs
        aXNoKGdlbl90b3BpYyhrZXkpLCBzdHIodmFsKSkKCgpkZWYgb25fcHBzKHRz
        KToKICAgIGlmIHRpbWVmaWxlIGFuZCBub3QgcGF1c2VkOgogICAgICAgIHNl
        YyA9IHNhbXBsZXNfdG90YWwgLyByYXRlCiAgICAgICAgZHQgPSBkYXRldGlt
        ZS5zdHJwdGltZSh0cywgIiVZLSVtLSVkVCVIOiVNOiVTLiVmWiIpCiAgICAg
        ICAgaWYgZHQuc2Vjb25kICUgYXJncy5yZWZlc2hfcHBzID09IDA6CiAgICAg
        ICAgICAgIGluZm8odHMpCiAgICAgICAgdGltZWZpbGUud3JpdGUoZiJ7c2Vj
        Oi4zZn1cdHtzZWM6LjNmfVx0e3RzfVxuIikKICAgICAgICB0aW1lZmlsZS5m
        bHVzaCgpCgoKZGVmIG9uX21lc3NhZ2UoY2xpZW50LCB1c2VyZGF0YSwgbXNn
        KToKICAgIHBheWxvYWQgPSBtc2cucGF5bG9hZC5kZWNvZGUoJ2xhdGluJyku
        c3RyaXAoKQogICAgdHJ5OgogICAgICAgIGlmIHBheWxvYWQgYW5kIG1zZy50
        b3BpYyA9PSBhcmdzLnBwc190b3BpYzoKICAgICAgICAgICAgb25fcHBzKHBh
        eWxvYWQpCiAgICAgICAgaWYgcGF5bG9hZCBhbmQgbXNnLnRvcGljID09IGFy
        Z3MudG9waWM6CiAgICAgICAgICAgIGNtZCwgXywgcGFyYW0gPSBwYXlsb2Fk
        LnBhcnRpdGlvbignICcpIAogICAgICAgICAgICBwYXJhbSA9IHBhcmFtLnN0
        cmlwKCkKICAgICAgICAgICAgaWYgY21kID09ICdpJzoKICAgICAgICAgICAg
        ICAgIG9uX2luZm8ocGFyYW0pCiAgICAgICAgICAgIGVsaWYgY21kID09ICdw
        JzoKICAgICAgICAgICAgICAgIG9uX3BhdXNlKHBhcmFtKQogICAgICAgICAg
        ICBlbGlmIGNtZCA9PSAnZyc6CiAgICAgICAgICAgICAgICBvbl9nYWluKHBh
        cmFtKQogICAgICAgICAgICBlbGlmIGNtZCA9PSAnYSc6CiAgICAgICAgICAg
        ICAgICBvbl9hdXRvKHBhcmFtKQogICAgICAgICAgICBlbGlmIGNtZCA9PSAn
        cic6CiAgICAgICAgICAgICAgICBvbl9yYXRlKHBhcmFtKQogICAgICAgICAg
        ICBlbGlmIGNtZCA9PSAnZic6CiAgICAgICAgICAgICAgICBvbl9mcmVxKHBh
        cmFtKQogICAgICAgICAgICBlbGlmIGNtZCA9PSAnayc6CiAgICAgICAgICAg
        ICAgICBvbl9raWxsKHBhcmFtKQogICAgICAgICAgICBlbGlmIGNtZCA9PSAn
        Syc6CiAgICAgICAgICAgICAgICBvbl9mYXRhbChwYXJhbSkKICAgICAgICAg
        ICAgZWxpZiBjbWQgPT0gJ2RzJzoKICAgICAgICAgICAgICAgIGlmIHBhcmFt
        Lmxvd2VyKCkgPT0gImkiOiBwYXJhbSA9ICIxIgogICAgICAgICAgICAgICAg
        aWYgcGFyYW0ubG93ZXIoKSA9PSAicSI6IHBhcmFtID0gIjIiCiAgICAgICAg
        ICAgICAgICBvbl9zZXR0aW5nKCJkaXJlY3Rfc2FtcCIsIHBhcmFtKQogICAg
        ICAgICAgICBlbGlmIGNtZCA9PSAnaXEnOgogICAgICAgICAgICAgICAgb25f
        c2V0dGluZygiaXFfc3dhcCIsIHBhcmFtKQogICAgICAgICAgICBlbGlmIGNt
        ZCA9PSAnYnQnOgogICAgICAgICAgICAgICAgb25fc2V0dGluZygiYmlhc3Rl
        ZSIsIHBhcmFtKQogICAgICAgICAgICBlbGlmIGNtZCA9PSAnZGEnOgogICAg
        ICAgICAgICAgICAgb25fc2V0dGluZygiZGlnaXRhbF9hZ2MiLCBwYXJhbSkK
        ICAgICAgICAgICAgZWxpZiBjbWQgPT0gJ290JzoKICAgICAgICAgICAgICAg
        IG9uX3NldHRpbmcoIm9mZnNldF90dW5lIiwgcGFyYW0pCiAgICAgICAgICAg
        IGVsc2U6CiAgICAgICAgICAgICAgICBpbmZvKCd1bmtub3duIGNvbW1hbmQn
        KQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGluZm8oZiJF
        eGNlcHRpb24gb25fbWVzc2FnZSgpOiB7ZX0iKQoKCmRlZiBvbl9jb25uZWN0
        KGNsaWVudCwgdXNlcmRhdGEsIGZsYWdzLCByYyk6CiAgICBjbGllbnQuc3Vi
        c2NyaWJlKGdlbl90b3BpYygnIycpKQogICAgY2xpZW50LnN1YnNjcmliZShh
        cmdzLnBwc190b3BpYykKCgojIyMjIyMjIyMjIyMjIyMzCgoKZGVmIGluZm8o
        cGF5bG9hZCk6CiAgICBwcmludChwYXlsb2FkLCBmaWxlPXN5cy5zdGRlcnIp
        CiAgICBpZiBicm9rZXI6CiAgICAgICAgYnJva2VyLnB1Ymxpc2goZ2VuX3Rv
        cGljKCJpbmZvIiksIHBheWxvYWQpCgoKZGVmIGxvZ19oYW5kbGVyKGxvZ19s
        ZXZlbCwgbG9nX21lc3NhZ2UpOgogICAgaWYgYnJva2VyOgogICAgICAgIGJy
        b2tlci5wdWJsaXNoKGdlbl90b3BpYygibG9nIiksIGxvZ19tZXNzYWdlKQoK
        CmRlZiB3YXZfaGVhZGVyKHJhdGUsIGNoYW5uZWxzPTIsIHNhbXBsZV9ieXRl
        cz00KToKICAgIHJhdGUgPSBpbnQocmF0ZSkKICAgIGRhdGFfaWQgPSBiJ2Rh
        dGEnCiAgICBkYXRhX3NpemUgPSAweDgwMDAwMDAwCiAgICByaWZmX2lkID0g
        YidSSUZGJwogICAgcmlmZl9mb3JtYXQgPSBiJ1dBVkUnCiAgICBmbXRfaWQg
        PSBiJ2ZtdCAnCiAgICBmbXRfc2l6ZSA9IDE2CiAgICBmbXRfZm9ybWF0ID0g
        MyAgICAjIElFRUVfRkxPQVQKICAgIGJ1ZiA9IHN0cnVjdC5wYWNrKCc8NHNJ
        NHMnLCByaWZmX2lkLCBkYXRhX3NpemUgKyAyMCArIGZtdF9zaXplLCByaWZm
        X2Zvcm1hdCkKICAgIGJ1ZiArPSBzdHJ1Y3QucGFjaygnPDRzSUhIJywgZm10
        X2lkLCBmbXRfc2l6ZSwgZm10X2Zvcm1hdCwgY2hhbm5lbHMpCiAgICBidWYg
        Kz0gc3RydWN0LnBhY2soJzxJSUhIJywKICAgICAgICByYXRlLCAgICAgICAg
        ICAgICAgICAgICAgICAgICAgICMgMzItYml0CiAgICAgICAgcmF0ZSAqIGNo
        YW5uZWxzICogc2FtcGxlX2J5dGVzLCAjIDMyLWJpdAogICAgICAgIGNoYW5u
        ZWxzICogc2FtcGxlX2J5dGVzLAogICAgICAgIHNhbXBsZV9ieXRlcyAqIDgp
        CiAgICBidWYgKz0gc3RydWN0LnBhY2soJzw0c0knLCBkYXRhX2lkLCBkYXRh
        X3NpemUpCiAgICByZXR1cm4gYnVmCgoKZGVmIHJhZGlvX2Nvbm5lY3QoKToK
        ICAgIGdsb2JhbCByYWRpbwogICAgZHJpdmVycyA9IFsgZFsnZHJpdmVyJ10g
        Zm9yIGQgaW4gU29hcHlTRFIuRGV2aWNlLmVudW1lcmF0ZSgpIF0KICAgIGlu
        Zm8oZiJGb3VuZCBkcml2ZXJzOiB7ZHJpdmVyc30iKQogICAga3cgPSB7fQog
        ICAgaWYgYXJncy5kcml2ZXI6CiAgICAgICAga3dbJ2RyaXZlciddID0gYXJn
        cy5kcml2ZXIKICAgIGluZm8oZiJQYXNzaW5nIHRoZSBmb2xsb3dpbmcgYXJn
        dW1lbnRzOiB7a3d9IikKICAgIHJhZGlvID0gU29hcHlTRFIuRGV2aWNlKGt3
        KQoKCmRlZiByYWRpb19zZXR0aW5ncygpOgogICAgaW5mbyhmIkluaXRpYWxp
        emluZyByYWRpbyBzZXR0aW5ncyIpCiAgICBpZiBhcmdzLmZyZXE6CiAgICAg
        ICAgcmFkaW8uc2V0RnJlcXVlbmN5KFNPQVBZX1NEUl9SWCwgMCwgYXJncy5m
        cmVxKQogICAgaWYgYXJncy5yYXRlOgogICAgICAgIHJhZGlvLnNldFNhbXBs
        ZVJhdGUoU09BUFlfU0RSX1JYLCAwLCBhcmdzLnJhdGUpCiAgICByYWRpby5z
        ZXRHYWluTW9kZShTT0FQWV9TRFJfUlgsIDAsIGFyZ3MuYWdjKTsKICAgIGlm
        IGFyZ3MuZ2FpbjoKICAgICAgICByYWRpby5zZXRHYWluKFNPQVBZX1NEUl9S
        WCwgMCwgYXJncy5nYWluKQogICAgaWYgYXJncy5kaXJlY3Rfc2FtcDoKICAg
        ICAgICBwYXJhbSA9IGFyZ3MuZGlyZWN0X3NhbXAKICAgICAgICBpZiBwYXJh
        bS5sb3dlcigpID09ICJpIjogcGFyYW0gPSAiMSIKICAgICAgICBpZiBwYXJh
        bS5sb3dlcigpID09ICJxIjogcGFyYW0gPSAiMiIKICAgICAgICByYWRpby53
        cml0ZVNldHRpbmcoImRpcmVjdF9zYW1wIiwgcGFyYW0pCiAgICBpZiBhcmdz
        LmlxX3N3YXA6CiAgICAgICAgcmFkaW8ud3JpdGVTZXR0aW5nKCJpcV9zd2Fw
        IiwgInRydWUiKQogICAgaWYgYXJncy5iaWFzdGVlOgogICAgICAgIHJhZGlv
        LndyaXRlU2V0dGluZygiYmlhc3RlZSIsICJ0cnVlIikKICAgIGlmIGFyZ3Mu
        ZGlnaXRhbF9hZ2M6CiAgICAgICAgcmFkaW8ud3JpdGVTZXR0aW5nKCJkaWdp
        dGFsX2FnYyIsICJ0cnVlIikKICAgIGlmIGFyZ3MuZGlnaXRhbF9hZ2M6CiAg
        ICAgICAgcmFkaW8ud3JpdGVTZXR0aW5nKCJvZmZzZXRfdHVuZSIsICJ0cnVl
        IikKCgpkZWYgbWFpbl9pbml0KCk6CiAgICBnbG9iYWwgcGF1c2VkLCBraWxs
        ZWQsIGZhdGFsCiAgICBraWxsZWQgPSBGYWxzZQogICAgZmF0YWwgPSBGYWxz
        ZQogICAgcGF1c2VkID0gYXJncy5wYXVzZQoKCmRlZiBicm9rZXJfaW5pdCgp
        OgogICAgZ2xvYmFsIGJyb2tlciwgdGltZWZpbGUKICAgIHRpbWVmaWxlID0g
        Tm9uZQogICAgYnJva2VyID0gTm9uZQogICAgaWYgbm90IGFyZ3Mubm9icm9r
        ZXI6CiAgICAgICAgaW5mbyhmIkNvbm5lY3RpbmcgdG8gYnJva2VyOiB7YXJn
        cy5icm9rZXJ9IikKICAgICAgICBicm9rZXIgPSBtcXR0LkNsaWVudCgpCiAg
        ICAgICAgYnJva2VyLm9uX2Nvbm5lY3QgPSBvbl9jb25uZWN0CiAgICAgICAg
        YnJva2VyLm9uX21lc3NhZ2UgPSBvbl9tZXNzYWdlCiAgICAgICAgYnJva2Vy
        LmNvbm5lY3QoYXJncy5icm9rZXIsIGFyZ3MuYnJva2VyX3BvcnQsIGFyZ3Mu
        YnJva2VyX2tlZXBhbGl2ZSkKICAgICAgICBicm9rZXIubG9vcF9zdGFydCgp
        CiAgICBpbmZvKCdJbml0aWFsaXppbmcnKQoKCmRlZiBtYWluKCk6CiAgICBi
        cm9rZXJfaW5pdCgpCiAgICBTb2FweVNEUi5yZWdpc3RlckxvZ0hhbmRsZXIo
        bG9nX2hhbmRsZXIpCiAgICBpbml0aWFsaXplZD0gRmFsc2UKICAgIHdoaWxl
        IFRydWU6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBtYWluX2luaXQoKQog
        ICAgICAgICAgICByYWRpb19jb25uZWN0KCkKICAgICAgICAgICAgaWYgbm90
        IGluaXRpYWxpemVkOgogICAgICAgICAgICAgICAgcmFkaW9fc2V0dGluZ3Mo
        KQogICAgICAgICAgICBpbml0aWFsaXplZCA9IFRydWUKICAgICAgICAgICAg
        cmFkaW9fc3RhcnQoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToK
        ICAgICAgICAgICAgaW5mbyhmIkV4Y2VwdGlvbiBtYWluKCk6IHtlfSIpCiAg
        ICAgICAgICAgIHRpbWUuc2xlZXAocmVzdGFydF9zZWNvbmRzKQoKCmRlZiBj
        bG9zZV9maWxlKGYsIG5hbWUpOgogICAgaWYgZjoKICAgICAgICBpbmZvKGYi
        Q2xvc2luZyB7bmFtZX0gZmlsZS4iKQogICAgICAgIGYuY2xvc2UoKQoKCmRl
        ZiBvcGVuX2ZpbGVzKCk6CiAgICBkdCA9IGRhdGV0aW1lLnV0Y25vdygpCiAg
        ICB0cyA9IGR0LnN0cmZ0aW1lKCcleSVtJWRfJUglTSVTJykKICAgIGZyZXEg
        PSByYWRpby5nZXRGcmVxdWVuY3koU09BUFlfU0RSX1JYLCAwKQogICAgYmFz
        ZW5hbWUgPSBmInthcmdzLm91dHB1dH1fe3RzfVpfe2ZyZXEvMWU2Oi42Zn1N
        SHoiCiAgICBleHQgPSAndHh0JwogICAgZmlsZW5hbWUgPSBmIntiYXNlbmFt
        ZX0ue2V4dH0iCiAgICBpbmZvKGYiT3BlbmluZyB7ZmlsZW5hbWV9IGZvciBn
        cHMgcHBzIHRpbWUiKQogICAgdGltZWZpbGUgPSBvcGVuKGZpbGVuYW1lLCAi
        dyIpCiAgICBleHQgPSAncmF3JyBpZiBhcmdzLm5vd2F2ZSBlbHNlICd3YXYn
        CiAgICBmaWxlbmFtZSA9IGYie2Jhc2VuYW1lfS57ZXh0fSIKICAgIGluZm8o
        ZiJPcGVuaW5nIHtmaWxlbmFtZX0gZm9yIGF1ZGlvIikKICAgIGF1ZGlvZmls
        ZSA9IG9wZW4oZmlsZW5hbWUsICJ3YiIpCiAgICBpZiBub3QgYXJncy5ub3dh
        dmU6CiAgICAgICAgYXVkaW9maWxlLndyaXRlKHdhdl9oZWFkZXIocmF0ZT1y
        YXRlKSkKICAgIHJldHVybiBhdWRpb2ZpbGUsIHRpbWVmaWxlCgoKZGVmIGNs
        b3NlX3N0cmVhbShzdHJlYW0pOgogICAgaW5mbyhmIkNsb3NpbmcgcmFkaW8g
        c3RyZWFtLiIpCiAgICByYWRpby5kZWFjdGl2YXRlU3RyZWFtKHN0cmVhbSkg
        CiAgICByYWRpby5jbG9zZVN0cmVhbShzdHJlYW0pCgoKZGVmIHJhZGlvX3Bl
        YWsocGVha19sZXZlbCk6CiAgICBkYiA9ICJ7Oi4xZn0gZEIiLmZvcm1hdCgy
        MCAqIG5wLmxvZzEwKHBlYWtfbGV2ZWwgKyAxZS05OSkpCiAgICBpZiBhcmdz
        Lm1ldGVyOgogICAgICAgIGJ1ZiA9IGYie2RifVxuIiBpZiBhcmdzLmR1bWIg
        ZWxzZSBmIlwzM1syS3tkYjo+OXN9XHIiCiAgICAgICAgcHJpbnQoYnVmLCBl
        bmQ9IiIsIGZpbGU9c3lzLnN0ZGVycikKICAgIGlmIGJyb2tlcjoKICAgICAg
        ICBicm9rZXIucHVibGlzaChnZW5fdG9waWMoInBlYWsiKSwgZGIpCgoKIyMj
        IyMjIyMjIyMjIyMjCgpzb2NrX2xpc3QgPSBbXQpzb2NrX3NlcnZlcj0gTm9u
        ZQoKCmRlZiBvcGVuX2Nvbm4oc29jaywgY2xpZW50X2FkZHJlc3MpOgogICAg
        c29ja19saXN0LmFwcGVuZChzb2NrKQoKCmRlZiBjbG9zZV9jb25uKHNvY2sp
        OgogICAgc29ja19saXN0LnJlbW92ZShzb2NrKQogICAgc29jay5jbG9zZSgp
        CgoKZGVmIGNsb3NlX3NlcnZlcigpOgogICAgZm9yIHNvY2sgaW4gc29ja19s
        aXN0OgogICAgICAgIHNvY2suY2xvc2UoKQoKCmRlZiB0Y3Bfc2VydmVyKGRh
        dGEpOgogICAgaWYgYXJncy5ydGx0Y3A6CiAgICAgICAgZGF0YSA9IChkYXRh
        ICogMTI4ICsgMTI4KS5hc3R5cGUoJ0InKQogICAgcmVhZGFibGUsIHdyaXRh
        YmxlLCBleGNlcHRpb25hbCA9IHNlbGVjdC5zZWxlY3Qoc29ja19saXN0LCBz
        b2NrX2xpc3QsIHNvY2tfbGlzdCwgMCkKICAgIGZvciBzb2NrIGluIHNvY2tf
        bGlzdDoKICAgICAgICBpZiBzb2NrIGluIGV4Y2VwdGlvbmFsOgogICAgICAg
        ICAgICBjbG9zZV9jb25uKHNvY2spCiAgICBmb3Igc29jayBpbiBzb2NrX2xp
        c3Q6CiAgICAgICAgaWYgc29jayBpbiB3cml0YWJsZToKICAgICAgICAgICAg
        dHJ5OgogICAgICAgICAgICAgICAgc29jay5zZW5kYWxsKGRhdGEpCiAgICAg
        ICAgICAgIGV4Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgY2xvc2Vf
        Y29ubihzb2NrKQogICAgZm9yIHNvY2sgaW4gc29ja19saXN0OgogICAgICAg
        IGlmIHNvY2sgaW4gcmVhZGFibGU6CiAgICAgICAgICAgIGlmIHNvY2sgPT0g
        c29ja19zZXJ2ZXI6CiAgICAgICAgICAgICAgICBjb25uLCBjbGllbnRfYWRk
        cmVzcyA9IHNvY2suYWNjZXB0KCkKICAgICAgICAgICAgICAgIG9wZW5fY29u
        bihjb25uLCBjbGllbnRfYWRkcmVzcykKICAgICAgICAgICAgICAgIGlmIG5v
        dCBhcmdzLmZsb2F0OgogICAgICAgICAgICAgICAgICAgIHR1bmVyX251bWJl
        ciA9IDUgIyBSODIwVAogICAgICAgICAgICAgICAgICAgIHR1bmVyX2dhaW5z
        ID0gMjkgIyBSODIwVAogICAgICAgICAgICAgICAgICAgIGRvbmdsZV9pbmZv
        ID0gc3RydWN0LnBhY2soJz40c0lJJywgYidSVEwwJywgdHVuZXJfbnVtYmVy
        LCB0dW5lcl9nYWlucykKICAgICAgICAgICAgICAgICAgICBjb25uLnNlbmRh
        bGwoZG9uZ2xlX2luZm8pCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAg
        ICAgICBzb2NrLnJlY3YoNDA5NikKCgpkZWYgaW5pdF9zZXJ2ZXIoKToKICAg
        IGdsb2JhbCBzb2NrX3NlcnZlciwgc29ja19saXN0CiAgICBzb2NrID0gc29j
        a2V0LnNvY2tldChzb2NrZXQuQUZfSU5FVCwgc29ja2V0LlNPQ0tfU1RSRUFN
        KQogICAgc29jay5zZXRzb2Nrb3B0KHNvY2tldC5TT0xfU09DS0VULCBzb2Nr
        ZXQuU09fUkVVU0VBRERSLCAxKQogICAgc29jay5iaW5kKChhcmdzLmhvc3Qs
        IGFyZ3MucG9ydCkpCiAgICBzb2NrLmxpc3RlbigpCiAgICBzb2NrX2xpc3Qg
        PSBbIHNvY2sgXQogICAgc29ja19zZXJ2ZXIgPSBzb2NrCgoKZGVmIHJhZGlv
        X3N0YXJ0KCk6CiAgICBnbG9iYWwgcmF0ZSwgdGltZWZpbGUsIHNhbXBsZXNf
        dG90YWwKICAgIGlmIG5vdCBhcmdzLm5vc2VydmVyOiAKICAgICAgICBpbml0
        X3NlcnZlcigpCiAgICByYXRlID0gcmFkaW8uZ2V0U2FtcGxlUmF0ZShTT0FQ
        WV9TRFJfUlgsIDApCiAgICBkYXRhID0gbnAuYXJyYXkoWzBdICogYXJncy5w
        YWNrZXRfc2l6ZSAqIDIsIG5wLmZsb2F0MzIpCiAgICBzdHJlYW0gPSByYWRp
        by5zZXR1cFN0cmVhbShTT0FQWV9TRFJfUlgsIFNPQVBZX1NEUl9DRjMyKQog
        ICAgcmFkaW8uYWN0aXZhdGVTdHJlYW0oc3RyZWFtKSAKICAgIHNhbXBsZXNf
        dG90YWwgPSAwCiAgICBwZWFrX2xldmVsID0gMAogICAgc2FtcGxlX251bSA9
        IDAKICAgIG91dGZpbGUgPSBOb25lCiAgICB0cnk6CiAgICAgICAgd2hpbGUg
        bm90IGtpbGxlZCBhbmQgbm90IGZhdGFsOgogICAgICAgICAgICByYWRpby5y
        ZWFkU3RyZWFtKHN0cmVhbSwgW2RhdGFdLCBhcmdzLnBhY2tldF9zaXplKQog
        ICAgICAgICAgICBpZiBub3QgcGF1c2VkOgogICAgICAgICAgICAgICAgaWYg
        bm90IG91dGZpbGU6CiAgICAgICAgICAgICAgICAgICAgb3V0ZmlsZSwgdGlt
        ZWZpbGUgPSBvcGVuX2ZpbGVzKCkKICAgICAgICAgICAgICAgIHNhbXBsZXNf
        dG90YWwgKz0gYXJncy5wYWNrZXRfc2l6ZQogICAgICAgICAgICAgICAgb3V0
        ZmlsZS53cml0ZShkYXRhKQogICAgICAgICAgICBpZiBub3QgYXJncy5ub3Nl
        cnZlcjoKICAgICAgICAgICAgICAgIHRjcF9zZXJ2ZXIoZGF0YSkKCiAgICAg
        ICAgICAgICMgcGVhayBtZXRlcgogICAgICAgICAgICBwZWFrX2xldmVsID0g
        bWF4KHBlYWtfbGV2ZWwsIGFicyhkYXRhLm1pbigpKSwgYWJzKGRhdGEubWF4
        KCkpKQogICAgICAgICAgICBzYW1wbGVfbnVtICs9IGFyZ3MucGFja2V0X3Np
        emUKICAgICAgICAgICAgaWYgc2FtcGxlX251bSA+IHJhdGUgKiBhcmdzLnJl
        ZnJlc2g6CiAgICAgICAgICAgICAgICByYWRpb19wZWFrKHBlYWtfbGV2ZWwp
        CiAgICAgICAgICAgICAgICBwZWFrX2xldmVsID0gMAogICAgICAgICAgICAg
        ICAgc2FtcGxlX251bSA9IDAKICAgIGV4Y2VwdCAoS2V5Ym9hcmRJbnRlcnJ1
        cHQsIFN5c3RlbUVycm9yKSBhcyBlOgogICAgICAgIGluZm8oZiJFeGNlcHRp
        b24gcmFkaW9fc3RhcnQoKToge2V9IikKICAgIGlmIG5vdCBhcmdzLm5vc2Vy
        dmVyOiAKICAgICAgICBjbG9zZV9zZXJ2ZXIoKQogICAgY2xvc2VfZmlsZShv
        dXRmaWxlLCAiYXVkaW8iKQogICAgdGltZWZpbGUgPSBjbG9zZV9maWxlKHRp
        bWVmaWxlLCAidGltZSIpCiAgICBjbG9zZV9zdHJlYW0oc3RyZWFtKQogICAg
        aWYgZmF0YWw6CiAgICAgICAgaW5mbygiRmF0YWwgY29tbWFuZCBnaXZlbiwg
        a2lsbGluZyBwcm9jZXNzIikKICAgICAgICBzeXMuZXhpdCgxKQoKCmlmIF9f
        bmFtZV9fID09ICdfX21haW5fXyc6CiAgICBhcmdzID0gcGFyc2VyLnBhcnNl
        X2FyZ3MoKQogICAgbWFpbigpCgo=


  - become: yes
    copy:
      mode: 0755
      dest: /usr/local/bin/mqclient
      content: !!binary |
        IyEvdXNyL2Jpbi9weXRob24zCgppbXBvcnQgc3lzCmltcG9ydCBhcmdwYXJz
        ZQppbXBvcnQgcGFoby5tcXR0LmNsaWVudCBhcyBtcXR0CgpwYXJzZXIgPSBh
        cmdwYXJzZS5Bcmd1bWVudFBhcnNlcigKICAgIGZvcm1hdHRlcl9jbGFzcz1h
        cmdwYXJzZS5Bcmd1bWVudERlZmF1bHRzSGVscEZvcm1hdHRlcikKcGFyc2Vy
        LmFkZF9hcmd1bWVudCgiLS1icm9rZXIiLCBkZWZhdWx0PSIxMjcuMC4wLjEi
        LCBoZWxwPSdicm9rZXIgaG9zdCcpCnBhcnNlci5hZGRfYXJndW1lbnQoIi0t
        cG9ydCIsIGRlZmF1bHQ9MTg4MywgaGVscD0nYnJva2VyIHBvcnQnKQpwYXJz
        ZXIuYWRkX2FyZ3VtZW50KCItLWtlZXBhbGl2ZSIsIGRlZmF1bHQ9NjAsIGhl
        bHA9J2Jyb2tlciBrZWVwIGFsaXZlJykKcGFyc2VyLmFkZF9hcmd1bWVudCgi
        LS10b3BpYyIsIGRlZmF1bHQ9ImYvdHgiLCBoZWxwPSdjb21tYW5kIHRvcGlj
        JykKCmRlZiBvbl9jb25uZWN0KGNsaWVudCwgdXNlcmRhdGEsIGZsYWdzLCBy
        Yyk6CiAgICBjbGllbnQuc3Vic2NyaWJlKCIjIikKCmRlZiBvbl9tZXNzYWdl
        KGNsaWVudCwgdXNlcmRhdGEsIG1zZyk6CiAgICBwcmludChtc2cudG9waWMg
        KyAiICIgKyBtc2cucGF5bG9hZC5kZWNvZGUoJ2xhdGluJykpCgpkZWYgbWFp
        bigpOgogICAgY2xpZW50ID0gbXF0dC5DbGllbnQoKQogICAgY2xpZW50Lm9u
        X2Nvbm5lY3QgPSBvbl9jb25uZWN0CiAgICBjbGllbnQub25fbWVzc2FnZSA9
        IG9uX21lc3NhZ2UKICAgIGNsaWVudC5jb25uZWN0KGFyZ3MuYnJva2VyLCBh
        cmdzLnBvcnQsIGFyZ3Mua2VlcGFsaXZlKQogICAgY2xpZW50Lmxvb3Bfc3Rh
        cnQoKQogICAgd2hpbGUgVHJ1ZToKICAgICAgICBsaW5lID0gbmV4dChzeXMu
        c3RkaW4pLnJzdHJpcCgpCiAgICAgICAgY2xpZW50LnB1Ymxpc2goYXJncy50
        b3BpYywgbGluZSkgCgppZiBfX25hbWVfXyA9PSAnX19tYWluX18nOgogICAg
        YXJncyA9IHBhcnNlci5wYXJzZV9hcmdzKCkKICAgIG1haW4oKQoKCg==



  # output directory

  - become: yes
    file: path={{ fs_path }} state=directory owner={{ user }} group={{ user }}

  - become: yes
    copy:
      dest: /lib/systemd/system/mqsoapy.service
      content: |
        [Service]
        ExecStart=/usr/bin/python3 -u /usr/local/bin/mqsoapy --pause --output {{ fs_path }}/out
        # WorkingDirectory={{ fs_path }}
        User=george
        Restart=on-failure
        RestartSec=10s
        [Install]
        WantedBy=multi-user.target

  - become: yes
    shell: |
      sudo systemctl enable mqsoapy
      sudo systemctl restart mqsoapy


