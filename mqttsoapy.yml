---
  - set_fact:
      fs_path: "{{ fs_path | default('/srv') }}"

  # apt

  - become: yes
    apt:
      name:
      - mosquitto

  # pip

  - become: yes
    pip:
      name:
      - paho-mqtt

  # code

  - become: yes
    copy:
      mode: 0755
      dest: /usr/local/bin/mqsoapy
      content: !!binary |
        IyEvdXNyL2Jpbi9weXRob24zCgppbXBvcnQgb3MsIHN5cywgdGltZQppbXBv
        cnQgc29ja2V0CmltcG9ydCBzdHJ1Y3QKaW1wb3J0IGFyZ3BhcnNlCmltcG9y
        dCBudW1weSBhcyBucAppbXBvcnQgcGFoby5tcXR0LmNsaWVudCBhcyBtcXR0
        CmltcG9ydCBTb2FweVNEUgpmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGlt
        ZQpmcm9tIFNvYXB5U0RSIGltcG9ydCBTT0FQWV9TRFJfUlgsIFNPQVBZX1NE
        Ul9DRjMyCgpyZXN0YXJ0X3NlY29uZHMgPSAxMAoKcGFyc2VyID0gYXJncGFy
        c2UuQXJndW1lbnRQYXJzZXIoCiAgICBmb3JtYXR0ZXJfY2xhc3M9YXJncGFy
        c2UuQXJndW1lbnREZWZhdWx0c0hlbHBGb3JtYXR0ZXIpCgojIGJyb2tlcgpw
        YXJzZXIuYWRkX2FyZ3VtZW50KCItLWJyb2tlciIsIGRlZmF1bHQ9IjEyNy4w
        LjAuMSIsIGhlbHA9J2Jyb2tlciBob3N0JykKcGFyc2VyLmFkZF9hcmd1bWVu
        dCgiLS1icm9rZXItcG9ydCIsIGRlZmF1bHQ9MTg4MywgdHlwZT1pbnQsIGhl
        bHA9J2Jyb2tlciBwb3J0JykKcGFyc2VyLmFkZF9hcmd1bWVudCgiLS1icm9r
        ZXIta2VlcGFsaXZlIiwgZGVmYXVsdD02MCwgdHlwZT1pbnQsIGhlbHA9J2Jy
        b2tlciBrZWVwYWxpdmUgc2Vjb25kcycpCnBhcnNlci5hZGRfYXJndW1lbnQo
        Ii0tdG9waWMiLCBkZWZhdWx0PSJmL3R4IiwgaGVscD0nbXF0dCB0b3BpYyBm
        b3IgY29tbWFuZCcpCnBhcnNlci5hZGRfYXJndW1lbnQoIi0tcHBzLXRvcGlj
        IiwgZGVmYXVsdD0icHBzIiwgaGVscD0nbXF0dCB0b3BpYyBmb3IgZ3BzIHBw
        cyB0aW1lJykKcGFyc2VyLmFkZF9hcmd1bWVudCgiLS1ub2Jyb2tlciIsIGFj
        dGlvbj0ic3RvcmVfdHJ1ZSIsIGhlbHA9ImRpc2FibGUgbXF0dCBicm9rZXIi
        KQpwYXJzZXIuYWRkX2FyZ3VtZW50KCItLXJlZnJlc2gtcHBzIiwgZGVmYXVs
        dD0xMCwgdHlwZT1pbnQsIGhlbHA9J3BwcyByZWZyZXNoIGluIHNlY29uZHMn
        KQoKIyBzb2FweQpwYXJzZXIuYWRkX2FyZ3VtZW50KCItLWRyaXZlciIsIGhl
        bHA9J25hbWUgb2YgZHJpdmVyJykKcGFyc2VyLmFkZF9hcmd1bWVudCgiLS1w
        YWNrZXQtc2l6ZSIsIGRlZmF1bHQ9MTAyNCwgdHlwZT1pbnQsIGhlbHA9J3Bh
        Y2tldCBzaXplJykKcGFyc2VyLmFkZF9hcmd1bWVudCgiLS1mcmVxIiwgdHlw
        ZT1ucC5mbG9hdCwgaGVscD0iY2VudGVyIGZyZXF1ZW5jeSBpbiBoZXJ0eiIp
        CnBhcnNlci5hZGRfYXJndW1lbnQoIi0tcmF0ZSIsIHR5cGU9bnAuZmxvYXQs
        IGhlbHA9InNhbXBsZSByYXRlIGluIGhlcnR6IikKcGFyc2VyLmFkZF9hcmd1
        bWVudCgiLS1nYWluIiwgdHlwZT1ucC5mbG9hdCwgaGVscD0iZnJvbnQgZW5k
        IGdhaW4gaW4gZEIiKQpwYXJzZXIuYWRkX2FyZ3VtZW50KCItLWFnYyIsIGFj
        dGlvbj0ic3RvcmVfdHJ1ZSIsIGhlbHA9ImVuYWJsZSBBR0MiKQoKIyBzb2Fw
        eSBhcmdTdHJpbmcKcGFyc2VyLmFkZF9hcmd1bWVudCgiLS1kaXJlY3Qtc2Ft
        cCIsIGhlbHA9IjA9b2ZmLCAxIG9yIGk9SSwgMiBvciBxPVEgY2hhbm5lbCIp
        CnBhcnNlci5hZGRfYXJndW1lbnQoIi0taXEtc3dhcCIsIGFjdGlvbj0ic3Rv
        cmVfdHJ1ZSIsIGhlbHA9InN3YXAgSVEgc2lnbmFscyIpCnBhcnNlci5hZGRf
        YXJndW1lbnQoIi0tYmlhc3RlZSIsIGFjdGlvbj0ic3RvcmVfdHJ1ZSIsIGhl
        bHA9ImVuYWJsZSBiaWFzIHRlZSIpCnBhcnNlci5hZGRfYXJndW1lbnQoIi0t
        ZGlnaXRhbC1hZ2MiLCBhY3Rpb249InN0b3JlX3RydWUiLCBoZWxwPSJlbmFi
        bGUgZGlnaXRhbCBBR0MiKQpwYXJzZXIuYWRkX2FyZ3VtZW50KCItLW9mZnNl
        dC10dW5lIiwgYWN0aW9uPSJzdG9yZV90cnVlIiwgaGVscD0iZW5hYmxlIG9m
        ZnNldCB0dW5lIikKCiMgb3RoZXIKcGFyc2VyLmFkZF9hcmd1bWVudCgiLS1v
        dXRwdXQiLCBkZWZhdWx0PSJvdXQiLCBoZWxwPSJ3cml0ZSBDRjMyIHNhbXBs
        ZXMgdG8gZmlsZSIpCnBhcnNlci5hZGRfYXJndW1lbnQoIi0tbm93YXZlIiwg
        YWN0aW9uPSJzdG9yZV90cnVlIiwgaGVscD0iZGlzYWJsZSBXQVYgaGVhZGVy
        IikKcGFyc2VyLmFkZF9hcmd1bWVudCgiLS1wYXVzZSIsIGFjdGlvbj0ic3Rv
        cmVfdHJ1ZSIsIGhlbHA9InBhdXNlIG91dHB1dCIpCgojIHBlYWsgbWV0ZXIK
        cGFyc2VyLmFkZF9hcmd1bWVudCgiLS1yZWZyZXNoIiwgZGVmYXVsdD01LCB0
        eXBlPWludCwgaGVscD0icGVhayBtZXRlciByZWZyZXNoIGluIHNlY29uZHMi
        KQpwYXJzZXIuYWRkX2FyZ3VtZW50KCItLW1ldGVyIiwgYWN0aW9uPSJzdG9y
        ZV90cnVlIiwgaGVscD0iZW5hYmxlIGNvbnNvbGUgcGVhayBtZXRlciIpCnBh
        cnNlci5hZGRfYXJndW1lbnQoIi0tZHVtYiIsIGFjdGlvbj0ic3RvcmVfdHJ1
        ZSIsIGhlbHA9ImVuYWJsZSBkdW1iIHRlcm1pbmFsIGNvbnNvbGUiKQogCiMg
        dGNwIHNlcnZlcgpwYXJzZXIuYWRkX2FyZ3VtZW50KCItLWhvc3QiLCBkZWZh
        dWx0PSIxMjcuMC4wLjEiLCBoZWxwPSJDRjMyIHRjcCBzZXJ2ZXIgaG9zdCBh
        ZGRyZXNzIikKcGFyc2VyLmFkZF9hcmd1bWVudCgiLS1wb3J0IiwgdHlwZT1p
        bnQsIGRlZmF1bHQ9MTIzNCwgaGVscD0iQ0YzMiB0Y3Agc2VydmVyIHBvcnQg
        YWRkcmVzcyIpCnBhcnNlci5hZGRfYXJndW1lbnQoIi0tcnRsdGNwIiwgYWN0
        aW9uPSJzdG9yZV90cnVlIiwgaGVscD0iZW5hYmxlIENVOCBydGx0Y3Agc2Vy
        dmVyIG1vZGUiKQpwYXJzZXIuYWRkX2FyZ3VtZW50KCItLW5vc2VydmVyIiwg
        YWN0aW9uPSJzdG9yZV90cnVlIiwgaGVscD0iZGlzYWJsZSB0Y3Agc2VydmVy
        IikKCgoKZGVmIGdlbl90b3BpYyhuYW1lPU5vbmUpOgogICAgZCA9IGFyZ3Mu
        dG9waWMuc3BsaXQoJy8nKVs6LTFdCiAgICBpZiBuYW1lIGlzIG5vdCBOb25l
        OgogICAgICAgIGQuYXBwZW5kKG5hbWUpCiAgICByZXR1cm4gJy8nLmpvaW4o
        ZCkKCgpkZWYgdG9fZmxvYXQocGFyYW0pOgogICAgdHJ5OgogICAgICAgIHJl
        dHVybiBmbG9hdChwYXJhbSkKICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAg
        ICAgIHBhc3MKCiMjIwoKZGVmIG9uX2luZm8ocGFyYW0pOgogICAgY2hhbiA9
        IDAKICAgIGZvciByIGluIHJhZGlvLmdldFNhbXBsZVJhdGVSYW5nZShTT0FQ
        WV9TRFJfUlgsIGNoYW4pOgogICAgICAgcGF5bG9hZCA9ICdyYXRlOiB7Oi4z
        Zn0gS0h6Jy5mb3JtYXQoci5taW5pbXVtKCkgLyAxZTMpCiAgICAgICBpbmZv
        KHBheWxvYWQpCiAgICBmb3IgciBpbiByYWRpby5nZXRGcmVxdWVuY3lSYW5n
        ZShTT0FQWV9TRFJfUlgsIGNoYW4pOgogICAgICAgcGF5bG9hZCA9ICdmcmVx
        OiB7Oi42Zn0gLSB7Oi42Zn0gTUh6Jy5mb3JtYXQoCiAgICAgICAgICAgci5t
        aW5pbXVtKCkgLyAxZTYsIHIubWF4aW11bSgpIC8gMWU2KQogICAgICAgaW5m
        byhwYXlsb2FkKQogICAgciA9IHJhZGlvLmdldEdhaW5SYW5nZShTT0FQWV9T
        RFJfUlgsIGNoYW4pCiAgICBwYXlsb2FkID0gJ2dhaW46IHs6LjJmfSAtIHs6
        LjJmfSBkQicuZm9ybWF0KHIubWluaW11bSgpLCByLm1heGltdW0oKSkKICAg
        IGluZm8ocGF5bG9hZCkKCgpkZWYgb25fZmF0YWwocGFyYW0pOgogICAgZ2xv
        YmFsIGZhdGFsCiAgICBpZiBwYXJhbS5sb3dlcigpID09ICJ0cnVlIjoKICAg
        ICAgICBmYXRhbCA9IFRydWUKICAgICAgICBpbmZvKCdmYXRhbCBraWxsaW5n
        JykKICAgIGVsc2U6CiAgICAgICAgaW5mbygnYmFkIGZhdGFsIGNvbW1hbmQn
        KQoKCmRlZiBvbl9raWxsKHBhcmFtKToKICAgIGdsb2JhbCBraWxsZWQKICAg
        IGlmIHBhcmFtLmxvd2VyKCkgPT0gInRydWUiOgogICAgICAgIGtpbGxlZCA9
        IFRydWUKICAgICAgICBpbmZvKCdraWxsaW5nIHN0cmVhbScpCiAgICBlbHNl
        OgogICAgICAgIGluZm8oJ2JhZCBraWxsIGNvbW1hbmQnKQoKCmRlZiBvbl9w
        YXVzZShwYXJhbSk6CiAgICBnbG9iYWwgcGF1c2VkCiAgICBpZiBwYXJhbToK
        ICAgICAgICBwYXVzZWQgPSBwYXJhbS5sb3dlcigpID09ICJ0cnVlIgogICAg
        YnJva2VyLnB1Ymxpc2goZ2VuX3RvcGljKCJwYXVzZSIpLCAnb24nIGlmIHBh
        dXNlZCBlbHNlICdvZmYnKQoKCmRlZiBvbl9yYXRlKHBhcmFtKToKICAgIGds
        b2JhbCByYXRlCiAgICBpZiBwYXJhbToKICAgICAgICBwYXJhbSA9IHRvX2Zs
        b2F0KHBhcmFtKQogICAgICAgIGlmIHBhcmFtIGlzIE5vbmU6CiAgICAgICAg
        ICAgIGluZm8oJ2JhZCBzYW1wbGUgcmF0ZSBjb21tYW5kJykKICAgICAgICBl
        bHNlOgogICAgICAgICAgICByYWRpby5zZXRTYW1wbGVSYXRlKFNPQVBZX1NE
        Ul9SWCwgMCwgcGFyYW0pCiAgICByYXRlID0gcmFkaW8uZ2V0U2FtcGxlUmF0
        ZShTT0FQWV9TRFJfUlgsIDApCiAgICBicm9rZXIucHVibGlzaChnZW5fdG9w
        aWMoInJhdGUiKSwgZid7cmF0ZS8xZTM6LjNmfSBLSHonKQoKCmRlZiBvbl9m
        cmVxKHBhcmFtKToKICAgIGlmIHBhcmFtOgogICAgICAgIHBhcmFtID0gdG9f
        ZmxvYXQocGFyYW0pCiAgICAgICAgaWYgcGFyYW0gaXMgTm9uZToKICAgICAg
        ICAgICAgaW5mbygnYmFkIGZyZXF1ZW5jeSBjb21tYW5kJykKICAgICAgICBl
        bHNlOgogICAgICAgICAgICByYWRpby5zZXRGcmVxdWVuY3koU09BUFlfU0RS
        X1JYLCAwLCBwYXJhbSkKICAgIGZyZXEgPSByYWRpby5nZXRGcmVxdWVuY3ko
        U09BUFlfU0RSX1JYLCAwKQogICAgYnJva2VyLnB1Ymxpc2goZ2VuX3RvcGlj
        KCJmcmVxIiksIGYne2ZyZXEvMWU2Oi42Zn0gTUh6JykKCgpkZWYgb25fZ2Fp
        bihwYXJhbSk6CiAgICBpZiBwYXJhbToKICAgICAgICBwYXJhbSA9IHRvX2Zs
        b2F0KHBhcmFtKQogICAgICAgIGlmIHBhcmFtIGlzIE5vbmU6CiAgICAgICAg
        ICAgIGluZm8oJ2JhZCBnYWluIGNvbW1hbmQnKQogICAgICAgIGVsc2U6CiAg
        ICAgICAgICAgIHJhZGlvLnNldEdhaW4oU09BUFlfU0RSX1JYLCAwLCBwYXJh
        bSkKICAgIGdhaW4gPSByYWRpby5nZXRHYWluKFNPQVBZX1NEUl9SWCwgMCkK
        ICAgIGJyb2tlci5wdWJsaXNoKGdlbl90b3BpYygiZ2FpbiIpLCBmJ3tnYWlu
        Oi4zZ30gZEInKQoKCmRlZiBvbl9hdXRvKHBhcmFtKToKICAgIGlmIHBhcmFt
        OgogICAgICAgIHJhZGlvLnNldEdhaW5Nb2RlKFNPQVBZX1NEUl9SWCwgMCwg
        cGFyYW0ubG93ZXIoKSA9PSAidHJ1ZSIpCiAgICBhZ2MgPSByYWRpby5nZXRH
        YWluTW9kZShTT0FQWV9TRFJfUlgsIDApCiAgICBicm9rZXIucHVibGlzaChn
        ZW5fdG9waWMoImFnYyIpLCAnb24nIGlmIGFnYyBlbHNlICdvZmYnKQoKCmRl
        ZiBvbl9zZXR0aW5nKGtleSwgcGFyYW0pOgogICAgaWYgcGFyYW06CiAgICAg
        ICAgcmFkaW8ud3JpdGVTZXR0aW5nKGtleSwgcGFyYW0pCiAgICB2YWwgPSBy
        YWRpby5yZWFkU2V0dGluZyhrZXkpCiAgICBicm9rZXIucHVibGlzaChnZW5f
        dG9waWMoa2V5KSwgc3RyKHZhbCkpCgoKZGVmIG9uX3Bwcyh0cyk6CiAgICBp
        ZiB0aW1lZmlsZSBhbmQgbm90IHBhdXNlZDoKICAgICAgICBzZWMgPSBzYW1w
        bGVzX3RvdGFsIC8gcmF0ZQogICAgICAgIGR0ID0gZGF0ZXRpbWUuc3RycHRp
        bWUodHMsICIlWS0lbS0lZFQlSDolTTolUy4lZloiKQogICAgICAgIGlmIGR0
        LnNlY29uZCAlIGFyZ3MucmVmZXNoX3BwcyA9PSAwOgogICAgICAgICAgICBp
        bmZvKHRzKQogICAgICAgIHRpbWVmaWxlLndyaXRlKGYie3NlYzouM2Z9XHR7
        c2VjOi4zZn1cdHt0c31cbiIpCiAgICAgICAgdGltZWZpbGUuZmx1c2goKQoK
        CmRlZiBvbl9tZXNzYWdlKGNsaWVudCwgdXNlcmRhdGEsIG1zZyk6CiAgICBw
        YXlsb2FkID0gbXNnLnBheWxvYWQuZGVjb2RlKCdsYXRpbicpLnN0cmlwKCkK
        ICAgIHRyeToKICAgICAgICBpZiBwYXlsb2FkIGFuZCBtc2cudG9waWMgPT0g
        YXJncy5wcHNfdG9waWM6CiAgICAgICAgICAgIG9uX3BwcyhwYXlsb2FkKQog
        ICAgICAgIGlmIHBheWxvYWQgYW5kIG1zZy50b3BpYyA9PSBhcmdzLnRvcGlj
        OgogICAgICAgICAgICBjbWQsIF8sIHBhcmFtID0gcGF5bG9hZC5wYXJ0aXRp
        b24oJyAnKSAKICAgICAgICAgICAgcGFyYW0gPSBwYXJhbS5zdHJpcCgpCiAg
        ICAgICAgICAgIGlmIGNtZCA9PSAnaSc6CiAgICAgICAgICAgICAgICBvbl9p
        bmZvKHBhcmFtKQogICAgICAgICAgICBlbGlmIGNtZCA9PSAncCc6CiAgICAg
        ICAgICAgICAgICBvbl9wYXVzZShwYXJhbSkKICAgICAgICAgICAgZWxpZiBj
        bWQgPT0gJ2cnOgogICAgICAgICAgICAgICAgb25fZ2FpbihwYXJhbSkKICAg
        ICAgICAgICAgZWxpZiBjbWQgPT0gJ2EnOgogICAgICAgICAgICAgICAgb25f
        YXV0byhwYXJhbSkKICAgICAgICAgICAgZWxpZiBjbWQgPT0gJ3InOgogICAg
        ICAgICAgICAgICAgb25fcmF0ZShwYXJhbSkKICAgICAgICAgICAgZWxpZiBj
        bWQgPT0gJ2YnOgogICAgICAgICAgICAgICAgb25fZnJlcShwYXJhbSkKICAg
        ICAgICAgICAgZWxpZiBjbWQgPT0gJ2snOgogICAgICAgICAgICAgICAgb25f
        a2lsbChwYXJhbSkKICAgICAgICAgICAgZWxpZiBjbWQgPT0gJ0snOgogICAg
        ICAgICAgICAgICAgb25fZmF0YWwocGFyYW0pCiAgICAgICAgICAgIGVsaWYg
        Y21kID09ICdkcyc6CiAgICAgICAgICAgICAgICBpZiBwYXJhbS5sb3dlcigp
        ID09ICJpIjogcGFyYW0gPSAiMSIKICAgICAgICAgICAgICAgIGlmIHBhcmFt
        Lmxvd2VyKCkgPT0gInEiOiBwYXJhbSA9ICIyIgogICAgICAgICAgICAgICAg
        b25fc2V0dGluZygiZGlyZWN0X3NhbXAiLCBwYXJhbSkKICAgICAgICAgICAg
        ZWxpZiBjbWQgPT0gJ2lxJzoKICAgICAgICAgICAgICAgIG9uX3NldHRpbmco
        ImlxX3N3YXAiLCBwYXJhbSkKICAgICAgICAgICAgZWxpZiBjbWQgPT0gJ2J0
        JzoKICAgICAgICAgICAgICAgIG9uX3NldHRpbmcoImJpYXN0ZWUiLCBwYXJh
        bSkKICAgICAgICAgICAgZWxpZiBjbWQgPT0gJ2RhJzoKICAgICAgICAgICAg
        ICAgIG9uX3NldHRpbmcoImRpZ2l0YWxfYWdjIiwgcGFyYW0pCiAgICAgICAg
        ICAgIGVsaWYgY21kID09ICdvdCc6CiAgICAgICAgICAgICAgICBvbl9zZXR0
        aW5nKCJvZmZzZXRfdHVuZSIsIHBhcmFtKQogICAgICAgICAgICBlbHNlOgog
        ICAgICAgICAgICAgICAgaW5mbygndW5rbm93biBjb21tYW5kJykKICAgIGV4
        Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBpbmZvKGYiRXhjZXB0aW9u
        IG9uX21lc3NhZ2UoKToge2V9IikKCgpkZWYgb25fY29ubmVjdChjbGllbnQs
        IHVzZXJkYXRhLCBmbGFncywgcmMpOgogICAgY2xpZW50LnN1YnNjcmliZShn
        ZW5fdG9waWMoJyMnKSkKICAgIGNsaWVudC5zdWJzY3JpYmUoYXJncy5wcHNf
        dG9waWMpCgoKIyMjIyMjIyMjIyMjIyMjMwoKCmRlZiBpbmZvKHBheWxvYWQp
        OgogICAgcHJpbnQocGF5bG9hZCwgZmlsZT1zeXMuc3RkZXJyKQogICAgaWYg
        YnJva2VyOgogICAgICAgIGJyb2tlci5wdWJsaXNoKGdlbl90b3BpYygiaW5m
        byIpLCBwYXlsb2FkKQoKCmRlZiBsb2dfaGFuZGxlcihsb2dfbGV2ZWwsIGxv
        Z19tZXNzYWdlKToKICAgIGlmIGJyb2tlcjoKICAgICAgICBicm9rZXIucHVi
        bGlzaChnZW5fdG9waWMoImxvZyIpLCBsb2dfbWVzc2FnZSkKCgpkZWYgd2F2
        X2hlYWRlcihyYXRlLCBjaGFubmVscz0yLCBzYW1wbGVfYnl0ZXM9NCk6CiAg
        ICByYXRlID0gaW50KHJhdGUpCiAgICBkYXRhX2lkID0gYidkYXRhJwogICAg
        ZGF0YV9zaXplID0gMHg4MDAwMDAwMAogICAgcmlmZl9pZCA9IGInUklGRicK
        ICAgIHJpZmZfZm9ybWF0ID0gYidXQVZFJwogICAgZm10X2lkID0gYidmbXQg
        JwogICAgZm10X3NpemUgPSAxNgogICAgZm10X2Zvcm1hdCA9IDMgICAgIyBJ
        RUVFX0ZMT0FUCiAgICBidWYgPSBzdHJ1Y3QucGFjaygnPDRzSTRzJywgcmlm
        Zl9pZCwgZGF0YV9zaXplICsgMjAgKyBmbXRfc2l6ZSwgcmlmZl9mb3JtYXQp
        CiAgICBidWYgKz0gc3RydWN0LnBhY2soJzw0c0lISCcsIGZtdF9pZCwgZm10
        X3NpemUsIGZtdF9mb3JtYXQsIGNoYW5uZWxzKQogICAgYnVmICs9IHN0cnVj
        dC5wYWNrKCc8SUlISCcsCiAgICAgICAgcmF0ZSwgICAgICAgICAgICAgICAg
        ICAgICAgICAgICAjIDMyLWJpdAogICAgICAgIHJhdGUgKiBjaGFubmVscyAq
        IHNhbXBsZV9ieXRlcywgIyAzMi1iaXQKICAgICAgICBjaGFubmVscyAqIHNh
        bXBsZV9ieXRlcywKICAgICAgICBzYW1wbGVfYnl0ZXMgKiA4KQogICAgYnVm
        ICs9IHN0cnVjdC5wYWNrKCc8NHNJJywgZGF0YV9pZCwgZGF0YV9zaXplKQog
        ICAgcmV0dXJuIGJ1ZgoKCmRlZiByYWRpb19jb25uZWN0KCk6CiAgICBnbG9i
        YWwgcmFkaW8KICAgIGRyaXZlcnMgPSBbIGRbJ2RyaXZlciddIGZvciBkIGlu
        IFNvYXB5U0RSLkRldmljZS5lbnVtZXJhdGUoKSBdCiAgICBpbmZvKGYiRm91
        bmQgZHJpdmVyczoge2RyaXZlcnN9IikKICAgIGt3ID0ge30KICAgIGlmIGFy
        Z3MuZHJpdmVyOgogICAgICAgIGt3Wydkcml2ZXInXSA9IGFyZ3MuZHJpdmVy
        CiAgICBpbmZvKGYiUGFzc2luZyB0aGUgZm9sbG93aW5nIGFyZ3VtZW50czog
        e2t3fSIpCiAgICByYWRpbyA9IFNvYXB5U0RSLkRldmljZShrdykKCgpkZWYg
        cmFkaW9fc2V0dGluZ3MoKToKICAgIGluZm8oZiJJbml0aWFsaXppbmcgcmFk
        aW8gc2V0dGluZ3MiKQogICAgaWYgYXJncy5mcmVxOgogICAgICAgIHJhZGlv
        LnNldEZyZXF1ZW5jeShTT0FQWV9TRFJfUlgsIDAsIGFyZ3MuZnJlcSkKICAg
        IGlmIGFyZ3MucmF0ZToKICAgICAgICByYWRpby5zZXRTYW1wbGVSYXRlKFNP
        QVBZX1NEUl9SWCwgMCwgYXJncy5yYXRlKQogICAgcmFkaW8uc2V0R2Fpbk1v
        ZGUoU09BUFlfU0RSX1JYLCAwLCBhcmdzLmFnYyk7CiAgICBpZiBhcmdzLmdh
        aW46CiAgICAgICAgcmFkaW8uc2V0R2FpbihTT0FQWV9TRFJfUlgsIDAsIGFy
        Z3MuZ2FpbikKICAgIGlmIGFyZ3MuZGlyZWN0X3NhbXA6CiAgICAgICAgcGFy
        YW0gPSBhcmdzLmRpcmVjdF9zYW1wCiAgICAgICAgaWYgcGFyYW0ubG93ZXIo
        KSA9PSAiaSI6IHBhcmFtID0gIjEiCiAgICAgICAgaWYgcGFyYW0ubG93ZXIo
        KSA9PSAicSI6IHBhcmFtID0gIjIiCiAgICAgICAgcmFkaW8ud3JpdGVTZXR0
        aW5nKCJkaXJlY3Rfc2FtcCIsIHBhcmFtKQogICAgaWYgYXJncy5pcV9zd2Fw
        OgogICAgICAgIHJhZGlvLndyaXRlU2V0dGluZygiaXFfc3dhcCIsICJ0cnVl
        IikKICAgIGlmIGFyZ3MuYmlhc3RlZToKICAgICAgICByYWRpby53cml0ZVNl
        dHRpbmcoImJpYXN0ZWUiLCAidHJ1ZSIpCiAgICBpZiBhcmdzLmRpZ2l0YWxf
        YWdjOgogICAgICAgIHJhZGlvLndyaXRlU2V0dGluZygiZGlnaXRhbF9hZ2Mi
        LCAidHJ1ZSIpCiAgICBpZiBhcmdzLmRpZ2l0YWxfYWdjOgogICAgICAgIHJh
        ZGlvLndyaXRlU2V0dGluZygib2Zmc2V0X3R1bmUiLCAidHJ1ZSIpCgoKZGVm
        IG1haW5faW5pdCgpOgogICAgZ2xvYmFsIHBhdXNlZCwga2lsbGVkLCBmYXRh
        bAogICAga2lsbGVkID0gRmFsc2UKICAgIGZhdGFsID0gRmFsc2UKICAgIHBh
        dXNlZCA9IGFyZ3MucGF1c2UKCgpkZWYgYnJva2VyX2luaXQoKToKICAgIGds
        b2JhbCBicm9rZXIsIHRpbWVmaWxlCiAgICB0aW1lZmlsZSA9IE5vbmUKICAg
        IGJyb2tlciA9IE5vbmUKICAgIGlmIG5vdCBhcmdzLm5vYnJva2VyOgogICAg
        ICAgIGluZm8oZiJDb25uZWN0aW5nIHRvIGJyb2tlcjoge2FyZ3MuYnJva2Vy
        fSIpCiAgICAgICAgYnJva2VyID0gbXF0dC5DbGllbnQoKQogICAgICAgIGJy
        b2tlci5vbl9jb25uZWN0ID0gb25fY29ubmVjdAogICAgICAgIGJyb2tlci5v
        bl9tZXNzYWdlID0gb25fbWVzc2FnZQogICAgICAgIGJyb2tlci5jb25uZWN0
        KGFyZ3MuYnJva2VyLCBhcmdzLmJyb2tlcl9wb3J0LCBhcmdzLmJyb2tlcl9r
        ZWVwYWxpdmUpCiAgICAgICAgYnJva2VyLmxvb3Bfc3RhcnQoKQoKCmRlZiBt
        YWluKCk6CiAgICBicm9rZXJfaW5pdCgpCiAgICBTb2FweVNEUi5yZWdpc3Rl
        ckxvZ0hhbmRsZXIobG9nX2hhbmRsZXIpCiAgICBpbml0aWFsaXplZD0gRmFs
        c2UKICAgIHdoaWxlIFRydWU6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBt
        YWluX2luaXQoKQogICAgICAgICAgICByYWRpb19jb25uZWN0KCkKICAgICAg
        ICAgICAgaWYgbm90IGluaXRpYWxpemVkOgogICAgICAgICAgICAgICAgcmFk
        aW9fc2V0dGluZ3MoKQogICAgICAgICAgICBpbml0aWFsaXplZCA9IFRydWUK
        ICAgICAgICAgICAgcmFkaW9fc3RhcnQoKQogICAgICAgIGV4Y2VwdCBFeGNl
        cHRpb24gYXMgZToKICAgICAgICAgICAgaW5mbyhmIkV4Y2VwdGlvbiBtYWlu
        KCk6IHtlfSIpCiAgICAgICAgICAgIHRpbWUuc2xlZXAocmVzdGFydF9zZWNv
        bmRzKQoKCmRlZiBjbG9zZV9maWxlKGYsIG5hbWUpOgogICAgaWYgZjoKICAg
        ICAgICBpbmZvKGYiQ2xvc2luZyB7bmFtZX0gZmlsZS4iKQogICAgICAgIGYu
        Y2xvc2UoKQoKCmRlZiBvcGVuX2ZpbGVzKCk6CiAgICBkdCA9IGRhdGV0aW1l
        LnV0Y25vdygpCiAgICB0cyA9IGR0LnN0cmZ0aW1lKCcleSVtJWRfJUglTSVT
        JykKICAgIGZyZXEgPSByYWRpby5nZXRGcmVxdWVuY3koU09BUFlfU0RSX1JY
        LCAwKQogICAgYmFzZW5hbWUgPSBmInthcmdzLm91dHB1dH1fe3RzfVpfe2Zy
        ZXEvMWU2Oi42Zn1NSHoiCiAgICBleHQgPSAndHh0JwogICAgZmlsZW5hbWUg
        PSBmIntiYXNlbmFtZX0ue2V4dH0iCiAgICBpbmZvKGYiT3BlbmluZyB7Zmls
        ZW5hbWV9IGZvciBncHMgcHBzIHRpbWUiKQogICAgdGltZWZpbGUgPSBvcGVu
        KGZpbGVuYW1lLCAidyIpCiAgICBleHQgPSAncmF3JyBpZiBhcmdzLm5vd2F2
        ZSBlbHNlICd3YXYnCiAgICBmaWxlbmFtZSA9IGYie2Jhc2VuYW1lfS57ZXh0
        fSIKICAgIGluZm8oZiJPcGVuaW5nIHtmaWxlbmFtZX0gZm9yIGF1ZGlvIikK
        ICAgIGF1ZGlvZmlsZSA9IG9wZW4oZmlsZW5hbWUsICJ3YiIpCiAgICBpZiBu
        b3QgYXJncy5ub3dhdmU6CiAgICAgICAgYXVkaW9maWxlLndyaXRlKHdhdl9o
        ZWFkZXIocmF0ZT1yYXRlKSkKICAgIHJldHVybiBhdWRpb2ZpbGUsIHRpbWVm
        aWxlCgoKZGVmIGNsb3NlX3N0cmVhbShzdHJlYW0pOgogICAgaW5mbyhmIkNs
        b3NpbmcgcmFkaW8gc3RyZWFtLiIpCiAgICByYWRpby5kZWFjdGl2YXRlU3Ry
        ZWFtKHN0cmVhbSkgCiAgICByYWRpby5jbG9zZVN0cmVhbShzdHJlYW0pCgoK
        ZGVmIHJhZGlvX3BlYWsocGVha19sZXZlbCk6CiAgICBkYiA9ICJ7Oi4xZn0g
        ZEIiLmZvcm1hdCgyMCAqIG5wLmxvZzEwKHBlYWtfbGV2ZWwgKyAxZS05OSkp
        CiAgICBpZiBhcmdzLm1ldGVyOgogICAgICAgIGJ1ZiA9IGYie2RifVxuIiBp
        ZiBhcmdzLmR1bWIgZWxzZSBmIlwzM1syS3tkYjo+OXN9XHIiCiAgICAgICAg
        cHJpbnQoYnVmLCBlbmQ9IiIsIGZpbGU9c3lzLnN0ZGVycikKICAgIGlmIGJy
        b2tlcjoKICAgICAgICBicm9rZXIucHVibGlzaChnZW5fdG9waWMoInBlYWsi
        KSwgZGIpCgoKIyMjIyMjIyMjIyMjIyMjMwoKc29ja19saXN0ID0gW10Kc29j
        a19zZXJ2ZXI9IE5vbmUKCmRlZiBvcGVuX2Nvbm4oc2VsZiwgc29jaywgY2xp
        ZW50X2FkZHJlc3MpOgogICAgc29ja19saXN0LmFwcGVuZChzb2NrKQoKCmRl
        ZiBjbG9zZV9jb25uKHNvY2spOgogICAgc29ja19saXN0LnJlbW92ZShzb2Nr
        KQogICAgc29jay5jbG9zZSgpCgoKZGVmIHRjcF9zZXJ2ZXIoZGF0YSk6CiAg
        ICBpZiBhcmdzLnJ0bHNkcjoKICAgICAgICBkYXRhID0gKGRhdGEgKiAxMjgg
        KyAxMjgpLmFzdHlwZSgnQicpCiAgICByZWFkYWJsZSwgd3JpdGFibGUsIGV4
        Y2VwdGlvbmFsID0gc2VsZWN0LnNlbGVjdChzb2NrX2xpc3QsIHNvY2tfbGlz
        dCwgc29ja19saXN0LCAwKQogICAgZm9yIHNvY2sgaW4gb3V0c29ja3M6CiAg
        ICAgICAgaWYgc29jayBpbiBleGNlcHRpb25hbDoKICAgICAgICAgICAgY2xv
        c2VfY29ubihzb2NrKQogICAgZm9yIHNvY2sgaW4gb3V0c29ja3M6CiAgICAg
        ICAgaWYgc29jayBpbiB3cml0YWJsZToKICAgICAgICAgICAgdHJ5OgogICAg
        ICAgICAgICAgICAgc29jay5zZW5kYWxsKGRhdGEpCiAgICAgICAgICAgIGV4
        Y2VwdCBPU0Vycm9yOgogICAgICAgICAgICAgICAgY2xvc2VfY29ubihzb2Nr
        KQogICAgZm9yIHNvY2sgaW4gaW5zb2NrczoKICAgICAgICBpZiBzb2NrIGlu
        IHJlYWRhYmxlOgogICAgICAgICAgICBpZiBzb2NrID09IHNvY2tfc2VydmVy
        OgogICAgICAgICAgICAgICAgY29ubiwgY2xpZW50X2FkZHJlc3MgPSBzb2Nr
        LmFjY2VwdCgpCiAgICAgICAgICAgICAgICBvcGVuX2Nvbm4oY29ubiwgY2xp
        ZW50X2FkZHJlc3MpCiAgICAgICAgICAgICAgICBpZiBub3QgYXJncy5mbG9h
        dDoKICAgICAgICAgICAgICAgICAgICB0dW5lcl9udW1iZXIgPSA1ICMgUjgy
        MFQKICAgICAgICAgICAgICAgICAgICB0dW5lcl9nYWlucyA9IDI5ICMgUjgy
        MFQKICAgICAgICAgICAgICAgICAgICBkb25nbGVfaW5mbyA9IHN0cnVjdC5w
        YWNrKCc+NHNJSScsIGInUlRMMCcsIHR1bmVyX251bWJlciwgdHVuZXJfZ2Fp
        bnMpCiAgICAgICAgICAgICAgICAgICAgY29ubi5zZW5kYWxsKGRvbmdsZV9p
        bmZvKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc29jay5y
        ZWN2KDQwOTYpCgoKZGVmIGluaXRfc2VydmVyKHNlbGYpOgogICAgZ2xvYmFs
        IHNvY2tfc2VydmVyLCBzb2NrX2xpc3QKICAgIHNvY2sgPSBzb2NrZXQuc29j
        a2V0KHNvY2tldC5BRl9JTkVULCBzb2NrZXQuU09DS19TVFJFQU0pCiAgICBz
        b2NrLnNldHNvY2tvcHQoc29ja2V0LlNPTF9TT0NLRVQsIHNvY2tldC5TT19S
        RVVTRUFERFIsIDEpCiAgICBzb2NrLmJpbmQoKGFyZ3MuaG9zdCwgYXJncy5w
        b3J0KSkKICAgIHNvY2subGlzdGVuKCkKICAgIHNvY2tfbGlzdCA9IFsgc29j
        ayBdCiAgICBzb2NrX3NlcnZlciA9IHNvY2sKCgpkZWYgcmFkaW9fc3RhcnQo
        KToKICAgIGdsb2JhbCByYXRlLCB0aW1lZmlsZSwgc2FtcGxlc190b3RhbAog
        ICAgaWYgbm90IGFyZ3Mubm9zZXJ2ZXI6IAogICAgICAgIGluaXRfc2VydmVy
        KCkKICAgIHJhdGUgPSByYWRpby5nZXRTYW1wbGVSYXRlKFNPQVBZX1NEUl9S
        WCwgMCkKICAgIGRhdGEgPSBucC5hcnJheShbMF0gKiBhcmdzLnBhY2tldF9z
        aXplICogMiwgbnAuZmxvYXQzMikKICAgIHN0cmVhbSA9IHJhZGlvLnNldHVw
        U3RyZWFtKFNPQVBZX1NEUl9SWCwgU09BUFlfU0RSX0NGMzIpCiAgICByYWRp
        by5hY3RpdmF0ZVN0cmVhbShzdHJlYW0pIAogICAgc2FtcGxlc190b3RhbCA9
        IDAKICAgIHBlYWtfbGV2ZWwgPSAwCiAgICBzYW1wbGVfbnVtID0gMAogICAg
        b3V0ZmlsZSA9IE5vbmUKICAgIHRyeToKICAgICAgICB3aGlsZSBub3Qga2ls
        bGVkIGFuZCBub3QgZmF0YWw6CiAgICAgICAgICAgIHJhZGlvLnJlYWRTdHJl
        YW0oc3RyZWFtLCBbZGF0YV0sIGFyZ3MucGFja2V0X3NpemUpCiAgICAgICAg
        ICAgIGlmIG5vdCBwYXVzZWQ6CiAgICAgICAgICAgICAgICBpZiBub3Qgb3V0
        ZmlsZToKICAgICAgICAgICAgICAgICAgICBvdXRmaWxlLCB0aW1lZmlsZSA9
        IG9wZW5fZmlsZXMoKQogICAgICAgICAgICAgICAgc2FtcGxlc190b3RhbCAr
        PSBhcmdzLnBhY2tldF9zaXplCiAgICAgICAgICAgICAgICBvdXRmaWxlLndy
        aXRlKGRhdGEpCiAgICAgICAgICAgIGlmIG5vdCBhcmdzLm5vc2VydmVyOgog
        ICAgICAgICAgICAgICAgdGNwX3NlcnZlcihkYXRhKQoKICAgICAgICAgICAg
        IyBwZWFrIG1ldGVyCiAgICAgICAgICAgIHBlYWtfbGV2ZWwgPSBtYXgocGVh
        a19sZXZlbCwgYWJzKGRhdGEubWluKCkpLCBhYnMoZGF0YS5tYXgoKSkpCiAg
        ICAgICAgICAgIHNhbXBsZV9udW0gKz0gYXJncy5wYWNrZXRfc2l6ZQogICAg
        ICAgICAgICBpZiBzYW1wbGVfbnVtID4gcmF0ZSAqIGFyZ3MucmVmcmVzaDoK
        ICAgICAgICAgICAgICAgIHJhZGlvX3BlYWsocGVha19sZXZlbCkKICAgICAg
        ICAgICAgICAgIHBlYWtfbGV2ZWwgPSAwCiAgICAgICAgICAgICAgICBzYW1w
        bGVfbnVtID0gMAogICAgZXhjZXB0IChLZXlib2FyZEludGVycnVwdCwgU3lz
        dGVtRXJyb3IpIGFzIGU6CiAgICAgICAgaW5mbyhmIkV4Y2VwdGlvbiByYWRp
        b19zdGFydCgpOiB7ZX0iKQogICAgY2xvc2VfZmlsZShvdXRmaWxlLCAiYXVk
        aW8iKQogICAgdGltZWZpbGUgPSBjbG9zZV9maWxlKHRpbWVmaWxlLCAidGlt
        ZSIpCiAgICBjbG9zZV9zdHJlYW0oc3RyZWFtKQogICAgaWYgZmF0YWw6CiAg
        ICAgICAgaW5mbygiRmF0YWwgY29tbWFuZCBnaXZlbiwga2lsbGluZyBwcm9j
        ZXNzIikKICAgICAgICBzeXMuZXhpdCgxKQoKCmlmIF9fbmFtZV9fID09ICdf
        X21haW5fXyc6CiAgICBhcmdzID0gcGFyc2VyLnBhcnNlX2FyZ3MoKQogICAg
        bWFpbigpCgo=


  - become: yes
    copy:
      mode: 0755
      dest: /usr/local/bin/mqclient
      content: !!binary |
        IyEvdXNyL2Jpbi9weXRob24zCgppbXBvcnQgc3lzCmltcG9ydCBhcmdwYXJz
        ZQppbXBvcnQgcGFoby5tcXR0LmNsaWVudCBhcyBtcXR0CgpwYXJzZXIgPSBh
        cmdwYXJzZS5Bcmd1bWVudFBhcnNlcigKICAgIGZvcm1hdHRlcl9jbGFzcz1h
        cmdwYXJzZS5Bcmd1bWVudERlZmF1bHRzSGVscEZvcm1hdHRlcikKcGFyc2Vy
        LmFkZF9hcmd1bWVudCgiLS1icm9rZXIiLCBkZWZhdWx0PSIxMjcuMC4wLjEi
        LCBoZWxwPSdicm9rZXIgaG9zdCcpCnBhcnNlci5hZGRfYXJndW1lbnQoIi0t
        cG9ydCIsIGRlZmF1bHQ9MTg4MywgaGVscD0nYnJva2VyIHBvcnQnKQpwYXJz
        ZXIuYWRkX2FyZ3VtZW50KCItLWtlZXBhbGl2ZSIsIGRlZmF1bHQ9NjAsIGhl
        bHA9J2Jyb2tlciBrZWVwIGFsaXZlJykKcGFyc2VyLmFkZF9hcmd1bWVudCgi
        LS10b3BpYyIsIGRlZmF1bHQ9ImYvdHgiLCBoZWxwPSdjb21tYW5kIHRvcGlj
        JykKCmRlZiBvbl9jb25uZWN0KGNsaWVudCwgdXNlcmRhdGEsIGZsYWdzLCBy
        Yyk6CiAgICBjbGllbnQuc3Vic2NyaWJlKCIjIikKCmRlZiBvbl9tZXNzYWdl
        KGNsaWVudCwgdXNlcmRhdGEsIG1zZyk6CiAgICBwcmludChtc2cudG9waWMg
        KyAiICIgKyBtc2cucGF5bG9hZC5kZWNvZGUoJ2xhdGluJykpCgpkZWYgbWFp
        bigpOgogICAgY2xpZW50ID0gbXF0dC5DbGllbnQoKQogICAgY2xpZW50Lm9u
        X2Nvbm5lY3QgPSBvbl9jb25uZWN0CiAgICBjbGllbnQub25fbWVzc2FnZSA9
        IG9uX21lc3NhZ2UKICAgIGNsaWVudC5jb25uZWN0KGFyZ3MuYnJva2VyLCBh
        cmdzLnBvcnQsIGFyZ3Mua2VlcGFsaXZlKQogICAgY2xpZW50Lmxvb3Bfc3Rh
        cnQoKQogICAgd2hpbGUgVHJ1ZToKICAgICAgICBsaW5lID0gbmV4dChzeXMu
        c3RkaW4pLnJzdHJpcCgpCiAgICAgICAgY2xpZW50LnB1Ymxpc2goYXJncy50
        b3BpYywgbGluZSkgCgppZiBfX25hbWVfXyA9PSAnX19tYWluX18nOgogICAg
        YXJncyA9IHBhcnNlci5wYXJzZV9hcmdzKCkKICAgIG1haW4oKQoKCg==



  # output directory

  - become: yes
    file: path={{ fs_path }} state=directory owner={{ user }} group={{ user }}

  - become: yes
    copy:
      dest: /lib/systemd/system/mqsoapy.service
      content: |
        [Service]
        ExecStart=/usr/bin/python3 -u /usr/local/bin/mqsoapy --pause --output {{ fs_path }}/out
        # WorkingDirectory={{ fs_path }}
        User=george
        Restart=on-failure
        RestartSec=10s
        [Install]
        WantedBy=multi-user.target

  - become: yes
    shell: |
      sudo systemctl enable mqsoapy
      sudo systemctl restart mqsoapy


